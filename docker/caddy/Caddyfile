# Pixelated Empathy Caddy Configuration
# Optimized for Ollama Exposure and Staging Subdomains

{
    email {$SSL_EMAIL:admin@pixelatedempathy.com}
    admin off
}

# Ollama API Subdomain
ollama.pixelatedempathy.tech {
    # Security: Enforce OLLAMA API key
    @unauthorized {
        not header Authorization "Bearer {$OLLAMA_API_KEY}"
        # Allow OPTIONS for CORS preflight
        not method OPTIONS
    }
    
    # Handle Unauthorized
    handle @unauthorized {
        respond "Unauthorized: Missing or invalid OLLAMA API Key" 401
    }

    # CORS Headers (Ollama handles some, but we ensure they are set for the proxy)
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
        Access-Control-Max-Age 3600
    }

    # Proxy to the remote OVH AI Deploy instance
    reverse_proxy {$OLLAMA_REMOTE_URL} {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # Security Headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }

    log {
        output stdout
        format console
    }
}

# Staging Application Subdomain
staging.pixelatedempathy.tech, pixelatedempathy.tech {
    # Proxy to the main Astro/React application
    reverse_proxy app:4321 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }

    # Security Headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options SAMEORIGIN
        Referrer-Policy strict-origin-when-cross-origin
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }

    log {
        output stdout
        format console
    }
}

# Default catch-all for port 80 (Redirect to HTTPS)
:80 {
    # Health check for the server itself
    handle /health {
        respond "OK" 200
    }

    # Redirect everything else to HTTPS
    handle {
        redir https://{host}{uri}
    }
}
