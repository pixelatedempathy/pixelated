name: Dependency Vulnerability Scan

permissions:
  contents: read

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "0 0 * * 0"

jobs:
  node_scan:
    name: Scan Node.js Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Install dependencies
        run: pnpm install

      - name: Run pnpm audit
        run: pnpm audit

  python_scan:
    name: Scan Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install uv (force latest)
        run: pip install --upgrade 'uv>=0.8.6'

      - name: Create virtual environment
        run: uv venv

      - name: Install project dependencies
        run: uv pip sync pyproject.toml

      - name: Install pip-audit in venv
        run: uv pip install --upgrade pip pip-audit

      - name: Run pip-audit (skip editable/local package)
        id: pip_audit
        continue-on-error: true
        run: |
          uv run pip-audit --skip-editable --format=columns 2>&1 | tee pip-audit-output.txt
          exit ${PIPESTATUS[0]}

      - name: Check for actionable vulnerabilities
        if: always()
        run: |
          # Check if pip-audit found any vulnerabilities
          if [ ! -f pip-audit-output.txt ]; then
            echo "‚ùå pip-audit output file not found"
            exit 1
          fi

          # Known acceptable vulnerabilities (CI/build tools only, not runtime dependencies)
          ACCEPTABLE_VULNS=(
            "GHSA-4xh5-x5gv-qwph"  # pip 25.2 (tool only)
            "GHSA-w476-p2h3-79g9"  # uv (tool only)
            "GHSA-pqhf-p39g-3x64"  # uv (tool only)
          )

          # Extract vulnerability lines (skip header and separator lines)
          # Format: package_name  version  GHSA-ID  fix_version
          VULN_LINES=$(grep -E "^[a-zA-Z0-9_-]+[[:space:]]+[^[:space:]]+[[:space:]]+GHSA-" pip-audit-output.txt || true)

          if [ -z "$VULN_LINES" ]; then
            echo "‚úÖ No vulnerabilities found"
            exit 0
          fi

          # Count actionable vulnerabilities (excluding acceptable ones)
          ACTIONABLE_COUNT=0
          ACTIONABLE_VULNS=""
          FOUND_ACCEPTABLE=""
          TOTAL_COUNT=$(echo "$VULN_LINES" | wc -l)

          while IFS= read -r line; do
            # Extract GHSA ID from line
            GHSA_ID=$(echo "$line" | grep -o "GHSA-[a-z0-9]*-[a-z0-9]*-[a-z0-9]*" | head -1)

            if [ -n "$GHSA_ID" ]; then
              # Check if this is an acceptable vulnerability
              IS_ACCEPTABLE=false
              for acceptable in "${ACCEPTABLE_VULNS[@]}"; do
                if [ "$GHSA_ID" = "$acceptable" ]; then
                  IS_ACCEPTABLE=true
                  FOUND_ACCEPTABLE="${FOUND_ACCEPTABLE}${GHSA_ID}\n"
                  break
                fi
              done

              if [ "$IS_ACCEPTABLE" = false ]; then
                ACTIONABLE_COUNT=$((ACTIONABLE_COUNT + 1))
                ACTIONABLE_VULNS="${ACTIONABLE_VULNS}${line}\n"
              fi
            fi
          done <<< "$VULN_LINES"

          # Report results
          echo "üìä Vulnerability Scan Results:"
          echo "   Total vulnerabilities found: $TOTAL_COUNT"
          echo "   Acceptable (CI tools): $((TOTAL_COUNT - ACTIONABLE_COUNT))"
          echo "   Actionable (requires update): $ACTIONABLE_COUNT"

          if [ "$ACTIONABLE_COUNT" -eq 0 ]; then
            echo ""
            echo "‚úÖ All vulnerabilities are in CI/build tools and are acceptable"
            if [ -n "$FOUND_ACCEPTABLE" ]; then
              echo "üìå Accepted vulnerabilities (CI tools only):"
              echo "$FOUND_ACCEPTABLE" | while IFS= read -r vuln_id; do
                [ -n "$vuln_id" ] || continue
                case "$vuln_id" in
                  "GHSA-4xh5-x5gv-qwph")
                    echo "   - pip 25.2 (GHSA-4xh5-x5gv-qwph): Minimal impact, affects package installation only"
                    ;;
                  "GHSA-w476-p2h3-79g9"|"GHSA-pqhf-p39g-3x64")
                    echo "   - uv (${vuln_id}): Build tool, not a runtime dependency"
                    ;;
                  *)
                    echo "   - ${vuln_id}: CI/build tool vulnerability (acceptable)"
                    ;;
                esac
              done
            fi
            exit 0
          else
            echo ""
            echo "‚ùå Found $ACTIONABLE_COUNT actionable vulnerabilities that need to be addressed:"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo -e "$ACTIONABLE_VULNS"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo ""
            echo "üìã Full audit output:"
            cat pip-audit-output.txt
            exit 1
          fi
