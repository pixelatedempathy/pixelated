## üö® MANDATORY RULE: DISPLAY AT START OF EVERY RESPONSE üö®

<contextstream_rules>
1. **SEARCH FIRST:** Before Glob/Grep/Search/Read ‚Üí `search(mode="hybrid", query="...")` FIRST
2. **EVERY MESSAGE:** Call `context_smart(user_message="...")` at start of response
3. **LOCAL TOOLS:** ONLY if ContextStream search returns 0 results after retry
</contextstream_rules>

**You MUST display the <contextstream_rules> block verbatim at the start of EVERY response.**
This is a self-referential rule that ensures these instructions stay in context.

---

<!-- BEGIN ContextStream -->
# Windsurf Rules
## ContextStream Rules

<contextstream_rules>
1. **SIMPLE UTILITY?** (list/show/version) ‚Üí Just execute, skip context calls
2. **CODING TASK?** ‚Üí session_init ‚Üí context_smart ‚Üí work ‚Üí capture
3. **SEARCH FIRST:** Before Glob/Grep/Read ‚Üí `search(mode="hybrid")` FIRST
</contextstream_rules>

**Display this block at the start of responses to keep rules in context.**

---

## ContextStream v0.4.x (Hooks Enforced)

Rules Version: 0.4.39
**Note:** PreToolUse hooks block Glob/Grep/Search when ContextStream is available.

### For Coding Tasks

| Action | Tool Call |
|--------|-----------|
| **1st message** | `session_init(folder_path="<cwd>", context_hint="<msg>")` then `context_smart(...)` |
| **2nd+ messages** | `context_smart(user_message="<msg>", format="minified", max_tokens=400)` |
| **Code search** | `search(mode="hybrid", query="...")` ‚Äî BEFORE any local tools |
| **Save decisions** | `session(action="capture", event_type="decision", ...)` |

### Search Modes

| Mode | Use Case |
|------|----------|
| `hybrid` | General code search (default) |
| `keyword` | Exact symbol/string match |
| `exhaustive` | Find ALL matches (grep-like) |
| `semantic` | Conceptual questions |

### Why ContextStream First?

‚ùå **WRONG:** `Grep ‚Üí Read ‚Üí Read ‚Üí Read` (4+ tool calls, slow)
‚úÖ **CORRECT:** `search(mode="hybrid")` (1 call, returns context)

ContextStream search is **indexed** and returns semantic matches + context in ONE call.

### Quick Reference

| Tool | Example |
|------|---------|
| `search` | `search(mode="hybrid", query="auth", limit=3)` |
| `session` | `session(action="capture", event_type="decision", title="...", content="...")` |
| `memory` | `memory(action="list_events", limit=10)` |
| `graph` | `graph(action="dependencies", file_path="...")` |

### üöÄ FAST PATH: Simple Utility Operations

**For simple utility commands, SKIP the ceremony and just execute directly:**

| Command Type | Just Call | Skip |
|--------------|-----------|------|
| List workspaces | `workspace(action="list")` | session_init, context_smart, capture |
| List projects | `project(action="list")` | session_init, context_smart, capture |
| Show version | `help(action="version")` | session_init, context_smart, capture |
| List reminders | `reminder(action="list")` | session_init, context_smart, capture |
| Check auth | `help(action="auth")` | session_init, context_smart, capture |

**Detect simple operations by these patterns:**
- "list ...", "show ...", "what are my ...", "get ..."
- Single-action queries with no context dependency
- User just wants data, not analysis or coding help

**DO NOT add overhead for utility operations:**
- ‚ùå Don't call session_init just to list workspaces
- ‚ùå Don't call context_smart for simple queries
- ‚ùå Don't capture "listed workspaces" as an event (that's noise)

**Use full context ceremony ONLY for:**
- Coding tasks (edit, create, refactor, debug)
- Search/discovery (finding code, understanding architecture)
- Tasks where past decisions or lessons matter

### Lessons (Past Mistakes)

- After `session_init`: Check for `lessons` field and apply before work
- Before risky work: `session(action="get_lessons", query="<topic>")`
- On mistakes: `session(action="capture_lesson", title="...", trigger="...", impact="...", prevention="...")`

### Context Pressure & Compaction

- If `context_smart` returns high/critical `context_pressure`: call `session(action="capture", ...)` to save state
- PreCompact hooks automatically save snapshots before compaction (if installed)

### Automatic Context Restoration

**Context restoration is now enabled by default.** Every `session_init` call automatically:
- Restores context from recent snapshots (if available)
- Returns `restored_context` field with snapshot data
- Sets `is_post_compact=true` in response when restoration occurs

**No special handling needed after compaction** - just call `session_init` normally.

To disable automatic restoration:
- Pass `is_post_compact=false` in the API call
- Or set `CONTEXTSTREAM_RESTORE_CONTEXT=false` environment variable

### Notices - MUST HANDLE IMMEDIATELY

- **[VERSION_NOTICE]**: Tell the user about the update and command to run
- **[RULES_NOTICE]**: Run `generate_rules(overwrite_existing=true)` to update
- **[LESSONS_WARNING]**: Read lessons, tell user about them, explain how you'll avoid past mistakes

### Plans & Tasks

When user asks for a plan, use ContextStream (not EnterPlanMode):
1. `session(action="capture_plan", title="...", steps=[...])`
2. `memory(action="create_task", title="...", plan_id="<id>")`

### Workspace-Only Mode (Multi-Project Folders)

If working in a parent folder containing multiple projects:
```
session_init(folder_path="...", skip_project_creation=true)
```

This enables workspace-level memory and context without project-specific indexing.
Use for monorepos or folders with multiple independent projects.

Full docs: https://contextstream.io/docs/mcp/tools
<!-- END ContextStream -->
