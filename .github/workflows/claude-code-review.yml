name: Claude Code Review

permissions:
  contents: read
  issues: read
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: tenki-standard-autoscale
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Check authentication configuration
        id: auth-check
        run: |
          # Check if NVIDIA secrets are set (non-empty)
          if [ -n "${{ secrets.NVIDIA_OPENAI_BASE_URL }}" ] && [ -n "${{ secrets.NVIDIA_API_KEY }}" ] && [ -n "${{ secrets.NVIDIA_OPENAI_MODEL }}" ]; then
            echo "has_nvidia=true" >> $GITHUB_OUTPUT
          else
            echo "has_nvidia=false" >> $GITHUB_OUTPUT
          fi

          # Check if Anthropic API key is set
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "has_anthropic=true" >> $GITHUB_OUTPUT
          else
            echo "has_anthropic=false" >> $GITHUB_OUTPUT
          fi

          # Check if Claude Code OAuth token is set
          if [ -n "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "has_oauth=true" >> $GITHUB_OUTPUT
          else
            echo "has_oauth=false" >> $GITHUB_OUTPUT
          fi

          # Determine if any auth method is available
          if [ "${{ secrets.NVIDIA_OPENAI_BASE_URL }}" != "" ] && [ "${{ secrets.NVIDIA_API_KEY }}" != "" ] && [ "${{ secrets.NVIDIA_OPENAI_MODEL }}" != "" ]; then
            echo "has_auth=true" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "has_auth=true" >> $GITHUB_OUTPUT
          elif [ -n "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "has_auth=true" >> $GITHUB_OUTPUT
          else
            echo "has_auth=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Bun
        if: steps.auth-check.outputs.has_nvidia == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.11"

      - name: Prepare Claude Code Router (OpenAI-compatible)
        if: steps.auth-check.outputs.has_nvidia == 'true'
        run: |
          mkdir -p $HOME/.claude-code-router
          cat << 'EOF' > $HOME/.claude-code-router/config.json
          {
            "log": true,
            "NON_INTERACTIVE_MODE": true,
            "OPENAI_BASE_URL": "${{ secrets.NVIDIA_OPENAI_BASE_URL }}",
            "OPENAI_API_KEY": "${{ secrets.NVIDIA_API_KEY }}",
            "OPENAI_MODEL": "${{ secrets.NVIDIA_OPENAI_MODEL }}"
          }
          EOF

      - name: Start Claude Code Router
        if: steps.auth-check.outputs.has_nvidia == 'true'
        run: |
          nohup ~/.bun/bin/bunx @musistudio/claude-code-router@1.0.71 start > $HOME/ccr.log 2>&1 &
        shell: bash

      - name: Wait for CCR to become healthy
        if: steps.auth-check.outputs.has_nvidia == 'true'
        run: |
          check_port() {
            if command -v nc >/dev/null 2>&1; then
              if nc -z localhost 3456 >/dev/null 2>&1; then
                return 0
              fi
            else
              if ss -tnl | grep -q ":3456 "; then
                return 0
              fi
            fi

            return 1
          }

          for i in {1..60}; do
            if curl -fsS http://localhost:3456/health > /dev/null 2>&1 || curl -fsS http://localhost:3456 > /dev/null 2>&1; then
              echo "CCR HTTP health check passed"
              exit 0
            fi

            if check_port; then
              echo "CCR port 3456 is accepting connections"
              exit 0
            fi

            echo "Waiting for CCR... ($i)"
            sleep 1
          done
          echo "CCR did not become healthy in time"
          echo "--- CCR LOG (tail) ---"
          tail -n 200 $HOME/ccr.log || true
          exit 1

      - name: Set Claude Code environment
        id: claude-env
        if: steps.auth-check.outputs.has_auth == 'true'
        run: |
          if [ "${{ steps.auth-check.outputs.has_nvidia }}" == "true" ]; then
            echo "base_url=http://localhost:3456" >> $GITHUB_OUTPUT
          else
            echo "base_url=" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        id: claude-review
        if: steps.auth-check.outputs.has_auth == 'true'
        uses: anthropics/claude-code-action@v1
        env:
          # If router is started, point Claude Code at it; dummy key is accepted per CCR guidance
          ANTHROPIC_BASE_URL: ${{ steps.claude-env.outputs.base_url }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY || 'any-string-is-ok' }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # Allow all bot actors to trigger the workflow
          allowed_bots: "*"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Skip Claude Code Review (no router or Anthropic credentials)
        if: steps.auth-check.outputs.has_auth == 'false'
        run: |
          echo "Skipping Claude Code Review: configure NVIDIA_OPENAI_BASE_URL, NVIDIA_API_KEY, NVIDIA_OPENAI_MODEL for CCR or provide ANTHROPIC_API_KEY/CLAUDE_CODE_OAUTH_TOKEN."