---
interface Props {
  sessions: any[]
  progress: any[]
  metrics: any
}

const { sessions = [], progress = [], metrics = {} } = Astro.props
const timeRange = '30d'
const selectedMetric = 'mood'

const filteredSessions = sessions.filter((session: any) => {
  const date = new Date(session.timestamp)
  const now = new Date()
  const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))
  return timeRange === '7d' ? diffDays <= 7 : diffDays <= 30
})

const moodData = filteredSessions.map((session: any) => ({
  date: new Date(session.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
  value: session.mood || 0
}))

const engagementData = filteredSessions.map((session: any) => ({
  date: new Date(session.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
  value: session.engagement || 0
}))

const pieData = [
  { name: 'Completed', value: metrics.completedSessions || 0 },
  { name: 'In Progress', value: metrics.inProgressSessions || 0 },
  { name: 'Cancelled', value: metrics.cancelledSessions || 0 }
]

const COLORS = ['#0088FE', '#00C49F', '#FFBB28']
---

<div class="space-y-6">
  <div class="flex justify-between items-center">
    <h2 class="text-2xl font-bold">Therapy Progress Analytics</h2>
    <div class="flex gap-4">
      <select class="px-3 py-2 border rounded-md">
        <option value="7d">Last 7 days</option>
        <option value="30d" selected>Last 30 days</option>
      </select>
      <select class="px-3 py-2 border rounded-md">
        <option value="mood" selected>Mood Tracking</option>
        <option value="engagement">Engagement</option>
      </select>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-lg font-semibold mb-4">Session Progress</h3>
      <div class="w-full h-72">
        <svg viewBox="0 0 800 300" class="w-full h-full">
          <!-- Grid lines -->
          <g stroke="#e5e7eb" stroke-width="1">
            <line x1="50" y1="20" x2="750" y2="20"></line>
            <line x1="50" y1="70" x2="750" y2="70"></line>
            <line x1="50" y1="120" x2="750" y2="120"></line>
            <line x1="50" y1="170" x2="750" y2="170"></line>
            <line x1="50" y1="220" x2="750" y2="220"></line>
            <line x1="50" y1="270" x2="750" y2="270"></line>
          </g>
          
          <!-- X-axis labels -->
          <g fill="#6b7280" font-size="12">
            {moodData.map((item, index) => (
              <text x={50 + (index * 700 / (moodData.length - 1))} y="290" text-anchor="middle">{item.date}</text>
            ))}
          </g>
          
          <!-- Y-axis labels -->
          <g fill="#6b7280" font-size="12">
            <text x="20" y="270" text-anchor="end">0</text>
            <text x="20" y="220" text-anchor="end">2</text>
            <text x="20" y="170" text-anchor="end">4</text>
            <text x="20" y="120" text-anchor="end">6</text>
            <text x="20" y="70" text-anchor="end">8</text>
            <text x="20" y="20" text-anchor="end">10</text>
          </g>
          
          <!-- Line chart -->
          <polyline
            fill="none"
            stroke="#8884d8"
            stroke-width="3"
            points={moodData.map((item, index) => 
              `${50 + (index * 700 / (moodData.length - 1))},${270 - (item.value * 25)}`
            ).join(' ')}
          ></polyline>
          
          <!-- Data points -->
          <g fill="#8884d8">
            {moodData.map((item, index) => (
              <circle
                cx={50 + (index * 700 / (moodData.length - 1))}
                cy={270 - (item.value * 25)}
                r="4"
              ></circle>
            ))}
          </g>
        </svg>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-lg font-semibold mb-4">Session Status</h3>
      <div class="w-full h-72 flex items-center justify-center">
        <svg viewBox="0 0 300 300" class="w-64 h-64">
          <!-- Pie chart -->
          <circle cx="150" cy="150" r="100" fill="#e5e7eb"></circle>
          
          <!-- Completed slice -->
          <path d="M150 50 A100 100 0 1 1 50 150 L150 150 Z" fill="#0088FE" opacity="0.8"></path>
          
          <!-- In Progress slice -->
          <path d="M50 150 A100 100 0 1 1 150 250 L150 150 Z" fill="#00C49F" opacity="0.8"></path>
          
          <!-- Cancelled slice -->
          <path d="M150 250 A100 100 0 1 1 150 50 L150 150 Z" fill="#FFBB28" opacity="0.8"></path>
          
          <!-- Center circle -->
          <circle cx="150" cy="150" r="40" fill="white"></circle>
          
          <!-- Labels -->
          <text x="150" y="155" text-anchor="middle" font-size="14" fill="#374151">Status</text>
        </svg>
        
        <div class="ml-4 space-y-2">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-[#0088FE] rounded-full"></div>
            <span class="text-sm">Completed</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-[#00C49F] rounded-full"></div>
            <span class="text-sm">In Progress</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-[#FFBB28] rounded-full"></div>
            <span class="text-sm">Cancelled</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white p-6 rounded-lg shadow">
      <h4 class="font-semibold mb-2">Total Sessions</h4>
      <p class="text-2xl font-bold">{metrics.totalSessions || 0}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow">
      <h4 class="font-semibold mb-2">Average Mood</h4>
      <p class="text-2xl font-bold">{(metrics.averageMood || 0).toFixed(1)}</p>
    </div>
    <div class="bg-white p-6 rounded-lg shadow">
      <h4 class="font-semibold mb-2">Completion Rate</h4>
      <p class="text-2xl font-bold">{(metrics.completionRate || 0).toFixed(1)}%</p>
    </div>
  </div>
</div>

<style>
  .space-y-6 > * + * {
    margin-top: 1.5rem;
  }
  
  .flex {
    display: flex;
  }
  
  .justify-between {
    justify-content: space-between;
  }
  
  .items-center {
    align-items: center;
  }
  
  .gap-4 {
    gap: 1rem;
  }
  
  .grid {
    display: grid;
  }
  
  .grid-cols-1 {
    grid-template-columns: repeat(1, minmax(0, 1fr));
  }
  
  .md\:grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
  
  .md\:grid-cols-3 {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
  
  .gap-6 {
    gap: 1.5rem;
  }
  
  .bg-white {
    background-color: white;
  }
  
  .p-6 {
    padding: 1.5rem;
  }
  
  .rounded-lg {
    border-radius: 0.5rem;
  }
  
  .shadow {
    box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1), 0 0 0 1px rgb(0 0 0 / 0.06);
  }
  
  .text-2xl {
    font-size: 1.5rem;
    line-height: 2rem;
  }
  
  .font-bold {
    font-weight: 700;
  }
  
  .text-lg {
    font-size: 1.125rem;
    line-height: 1.75rem;
  }
  
  .font-semibold {
    font-weight: 600;
  }
  
  .mb-4 {
    margin-bottom: 1rem;
  }
  
  .mb-2 {
    margin-bottom: 0.5rem;
  }
  
  .px-3 {
    padding-left: 0.75rem;
    padding-right: 0.75rem;
  }
  
  .py-2 {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }
  
  .border {
    border-width: 1px;
  }
  
  .w-full {
    width: 100%;
  }
  
  .h-72 {
    height: 18rem;
  }
  
  .w-64 {
    width: 16rem;
  }
  
  .h-64 {
    height: 16rem;
  }
  
  .ml-4 {
    margin-left: 1rem;
  }
  
  .space-y-2 > * + * {
    margin-top: 0.5rem;
  }
  
  .flex {
    display: flex;
  }
  
  .items-center {
    align-items: center;
  }
  
  .gap-2 {
    gap: 0.5rem;
  }
  
  .w-3 {
    width: 0.75rem;
  }
  
  .h-3 {
    height: 0.75rem;
  }
  
  .rounded-full {
    border-radius: 9999px;
  }
  
  .text-sm {
    font-size: 0.875rem;
    line-height: 1.25rem;
  }
  
  .text-center {
    text-align: center;
  }
  
  .text-anchor-middle {
    text-anchor: middle;
  }
  
  .fill-current {
    fill: currentColor;
  }
</style>