# Pixelated Empathy - Security Policy Configuration
# ================================================

apiVersion: v1
kind: SecurityPolicy
metadata:
  name: pixelated-empathy-security-policy
  namespace: default
spec:
  # Network Security Policies
  networkPolicies:
    - name: default-deny-all
      podSelector: {}
      policyTypes:
        - Ingress
        - Egress
    
    - name: allow-app-traffic
      podSelector:
        matchLabels:
          app: pixelated-empathy
      ingress:
        - from:
          - podSelector:
              matchLabels:
                app: nginx-ingress
          ports:
          - protocol: TCP
            port: 3000
      egress:
        - to:
          - podSelector:
              matchLabels:
                app: postgresql
          ports:
          - protocol: TCP
            port: 5432
        - to:
          - podSelector:
              matchLabels:
                app: redis
          ports:
          - protocol: TCP
            port: 6379

  # Pod Security Standards
  podSecurityStandards:
    enforce: "restricted"
    audit: "restricted"
    warn: "restricted"

  # Security Context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
    capabilities:
      drop:
        - ALL
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true

  # Resource Limits
  resourceLimits:
    memory: "512Mi"
    cpu: "500m"
    ephemeral-storage: "1Gi"

  # Image Security
  imageSecurity:
    allowedRegistries:
      - "ghcr.io/pixelated-empathy"
      - "docker.io/library"
    requireSignedImages: true
    scanForVulnerabilities: true
    maxCriticalVulnerabilities: 0
    maxHighVulnerabilities: 2

  # Secrets Management
  secretsManagement:
    encryptionAtRest: true
    rotationPolicy: "90d"
    accessLogging: true
    allowedSecretTypes:
      - "Opaque"
      - "kubernetes.io/tls"

  # Compliance Requirements
  compliance:
    standards:
      - "SOC2"
      - "GDPR"
      - "HIPAA"
    auditLogging: true
    dataRetention: "7y"
    encryptionInTransit: true
    encryptionAtRest: true

  # Access Control
  accessControl:
    rbac:
      enabled: true
      strictMode: true
    serviceAccounts:
      automountServiceAccountToken: false
    admission:
      controllers:
        - "PodSecurityPolicy"
        - "NetworkPolicy"
        - "ResourceQuota"

  # Monitoring & Alerting
  monitoring:
    securityEvents: true
    anomalyDetection: true
    threatDetection: true
    alerting:
      channels:
        - "slack"
        - "email"
        - "pagerduty"
    metrics:
      - "failed_authentications"
      - "privilege_escalations"
      - "network_policy_violations"
      - "suspicious_activities"
