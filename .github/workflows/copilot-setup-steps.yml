name: "Copilot Code Review"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:


jobs:
  copilot-code-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    environment: copilot

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v5
      with:
        node-version: "24"
        cache: "pnpm"

    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.17.1

    - name: Install dependencies
      run: pnpm install --no-frozen-lockfile

    - name: Lint (ESLint)
      run: pnpm exec eslint . --ext .js,.ts,.tsx,.astro

    - name: Format check (Prettier)
      run: pnpm exec prettier --check .

    - name: Run tests
      run: |
        if pnpm exec vitest --version 2>/dev/null; then
          pnpm exec vitest run --reporter=dot
        elif pnpm exec jest --version 2>/dev/null; then
          pnpm exec jest --ci
        else
          echo "No supported test runner found (vitest/jest)."
        fi

    - name: GitHub Copilot Code Review
      uses: github/copilot-review-action@v1
      with:
        github-token: ${{ secrets.G_TOKEN }}
