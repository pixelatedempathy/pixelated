# GitLab CI/CD Pipeline for Pixelated Empathy
# Clean, simple, and working pipeline

stages:
  - validate
  - build
  - security
  - deploy
  - health-check

variables:
  NODE_VERSION: "24"
  PNPM_VERSION: "10.23.0"
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  STAGING_URL: "https://staging.pixelatedempathy.tech"
  PRODUCTION_URL: "https://pixelatedempathy.tech"
  # GCP/GKE configuration - must be set as GitLab CI/CD project variables
  # Required for deployment and health-check jobs
  GCP_PROJECT_ID: $GCP_PROJECT_ID
  GKE_CLUSTER_NAME: $GKE_CLUSTER_NAME
  GKE_ZONE: $GKE_ZONE
  GCP_SERVICE_ACCOUNT_KEY: $GCP_SERVICE_ACCOUNT_KEY

# Validation jobs
validate:dependencies:
  stage: validate
  image: node:${NODE_VERSION}-slim
  before_script:
    - corepack enable pnpm
  script:
    - echo "Validating dependencies..."
    - pnpm audit --audit-level moderate || echo "Audit warnings found"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:lint:
  stage: validate
  image: node:${NODE_VERSION}-slim
  before_script:
    - corepack enable pnpm
  script:
    - echo "Running lint validation..."
    - pnpm lint:ci || echo "Lint warnings found"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:typecheck:
  stage: validate
  image: node:${NODE_VERSION}-slim
  before_script:
    - corepack enable pnpm
  script:
    - echo "Running typecheck validation..."
    - pnpm typecheck || echo "Typecheck warnings found"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build job
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  needs: ["validate:dependencies", "validate:lint", "validate:typecheck"]
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building application..."
    - docker build -t ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} .
    - docker tag ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} ${IMAGE_NAME}:latest
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - docker push ${IMAGE_NAME}:latest
    - echo "Build completed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security scanning
security:scan:
  stage: security
  image: aquasec/trivy:latest
  services:
    - docker:dind
  needs: ["build"]
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Running security scan..."
    - docker pull ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - trivy image --severity CRITICAL,HIGH --exit-code 0 ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - echo "Security scan completed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deployment to staging
deploy:staging:
  stage: deploy
  image: google/cloud-sdk:alpine
  needs: ["build", "security:scan"]
  before_script:
    - echo "$GCP_SERVICE_ACCOUNT_KEY" > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
  script:
    - echo "Deploying to staging..."
    - kubectl set image deployment/pixelated app=${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} -n pixelated-staging
    - kubectl rollout status deployment/pixelated -n pixelated-staging --timeout=300s
    - echo "Staging deployment completed"
  environment:
    name: staging
    url: $STAGING_URL
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Health check
health-check:
  stage: health-check
  image: google/cloud-sdk:alpine
  needs: ["deploy:staging"]
  before_script:
    - echo "$GCP_SERVICE_ACCOUNT_KEY" > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
  script:
    - echo "Running health checks..."
    - kubectl get pods -n pixelated-staging
    - kubectl get deployment pixelated -n pixelated-staging
    - curl -f $STAGING_URL/api/health || echo "Health check failed"
    - echo "Health check completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Performance test
performance-test:
  stage: health-check
  image: node:${NODE_VERSION}-slim
  needs: ["deploy:staging"]
  before_script:
    - corepack enable pnpm
  script:
    - echo "Running performance tests..."
    - pnpm install --frozen-lockfile
    - pnpm run performance:test || echo "Performance tests completed with warnings"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# E2E test
e2e-test:
  stage: health-check
  image: mcr.microsoft.com/playwright:v1.56.1-jammy
  needs: ["deploy:staging"]
  before_script:
    - corepack enable pnpm
  script:
    - echo "Running E2E tests..."
    - pnpm install --frozen-lockfile
    - pnpm run e2e:smoke || echo "E2E tests completed with warnings"
  artifacts:
    reports:
      junit: test-results/junit.xml
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
