name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        if: ${{ secrets.NVIDIA_OPENAI_BASE_URL != '' && secrets.NVIDIA_API_KEY != '' && secrets.NVIDIA_OPENAI_MODEL != '' }}
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.2.11'

      - name: Prepare Claude Code Router (OpenAI-compatible)
        if: ${{ secrets.NVIDIA_OPENAI_BASE_URL != '' && secrets.NVIDIA_API_KEY != '' && secrets.NVIDIA_OPENAI_MODEL != '' }}
        run: |
          mkdir -p $HOME/.claude-code-router
          cat << 'EOF' > $HOME/.claude-code-router/config.json
          {
            "log": true,
            "NON_INTERACTIVE_MODE": true,
            "OPENAI_BASE_URL": "${{ secrets.NVIDIA_OPENAI_BASE_URL }}",
            "OPENAI_API_KEY": "${{ secrets.NVIDIA_API_KEY }}",
            "OPENAI_MODEL": "${{ secrets.NVIDIA_OPENAI_MODEL }}"
          }
          EOF
        shell: bash

      - name: Start Claude Code Router
        if: ${{ secrets.NVIDIA_OPENAI_BASE_URL != '' && secrets.NVIDIA_API_KEY != '' && secrets.NVIDIA_OPENAI_MODEL != '' }}
        run: |
          nohup ~/.bun/bin/bunx @musistudio/claude-code-router@1.0.8 start > $HOME/ccr.log 2>&1 &
        shell: bash

      - name: Wait for CCR to become healthy
        if: ${{ secrets.NVIDIA_OPENAI_BASE_URL != '' && secrets.NVIDIA_API_KEY != '' && secrets.NVIDIA_OPENAI_MODEL != '' }}
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:3456/health > /dev/null 2>&1 || curl -fsS http://localhost:3456 > /dev/null 2>&1; then
              echo "CCR is up"
              exit 0
            fi
            echo "Waiting for CCR... ($i)"
            sleep 1
          done
          echo "CCR did not become healthy in time"
          echo "--- CCR LOG (tail) ---"
          tail -n 200 $HOME/ccr.log || true
          exit 1

      - name: Run Claude Code
        id: claude
        if: ${{ (secrets.NVIDIA_OPENAI_BASE_URL != '' && secrets.NVIDIA_API_KEY != '' && secrets.NVIDIA_OPENAI_MODEL != '') || secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '' }}
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: http://localhost:3456
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY || 'any-string-is-ok' }}
          claude_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          # Allow all bot actors to trigger the workflow
          allowed_bots: "*"

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Optional: Add claude_args to customize behavior and configuration
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          # claude_args: '--allowed-tools Bash(gh pr:*)'

      - name: Skip Claude Code (no router or Anthropic credentials)
        if: ${{ !((secrets.NVIDIA_OPENAI_BASE_URL != '' && secrets.NVIDIA_API_KEY != '' && secrets.NVIDIA_OPENAI_MODEL != '') || secrets.ANTHROPIC_API_KEY != '' || secrets.CLAUDE_CODE_OAUTH_TOKEN != '') }}
        run: |
          echo "Skipping Claude Code run: configure NVIDIA_OPENAI_BASE_URL, NVIDIA_API_KEY, NVIDIA_OPENAI_MODEL for CCR or provide ANTHROPIC_API_KEY/CLAUDE_CODE_OAUTH_TOKEN."
