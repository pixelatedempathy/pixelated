---
// Grouped imports for better organization
// Style imports
import '@unocss/reset/tailwind.css'
import '@/styles/main.css'
import '@/styles/prose.css'
import '@/styles/markdown.css'
import '@/styles/page.css'

// Astro components
import Head from '@/components/base/Head.astro'
import ErrorBoundary from '@/components/base/ErrorBoundary.astro'

// Layout components
import Header from '@/components/layout/Header.astro'
import Footer from '@/components/mizu/Footer.astro'
import Sidebar from '@/components/layout/Sidebar.astro'

// Define a more robust props interface with JSDoc comments
interface Props {
  /** Page title - displayed in browser tab */
  title?: string
  /** Meta description for SEO */
  description?: string
  /** URL for the Open Graph image (social sharing) */
  metaImage?: string
  /** Control visibility of layout elements */
  showHeader?: boolean
  showFooter?: boolean
  showSidebar?: boolean
  /** Control features of layout elements */
  showThemeToggle?: boolean
  showUserMenu?: boolean
  showSocialLinks?: boolean
  /** Additional class names for the content container */
  contentClassName?: string
}

const {
  title = 'Pixelated Empathy Therapy | Dashboard',
  description = 'Advanced therapeutic tools for mental health professionals',
  metaImage = '/og-image.png',
  showHeader = true,
  showFooter = true,
  showSidebar = true,
  showThemeToggle = true,
  showUserMenu = true,
  showSocialLinks = true,
  contentClassName = '',
} = Astro.props

const { cspNonce } = Astro.locals
---

<!doctype html>
<html lang="en" class="dark scroll-smooth">
  <Head {title} {description} ogImage={metaImage} />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#0f172a" />

  <link rel="stylesheet" href="/css/unified-dark-theme-v3.css" />
  <link rel="stylesheet" href="/css/design-system.css" />
  <link rel="stylesheet" href="/css/unified-blended-theme.css" />

  <link rel="stylesheet" href="/css/fonts.css" />
  <link rel="stylesheet" href="/css/font-fix.css" />

  <link rel="stylesheet" href="/css/background-fixes.css" />

  <script src="/js/polyfill-detector.js" is:inline></script>
  <script src="/js/module-loader.js" defer is:inline></script>
  <script src="/js/background-loader.js" defer is:inline></script>
  <style is:global>
    /* Mizu theme dark colors - default for all pages */
    :root {
      --c-bg: #0f172a;
      --c-text: #f8fafc;
      --c-scrollbar: #181818;
      --c-scrollbar-hover: #1f1f1f;
    }

    html {
      background-color: #0f172a;
      color: #f8fafc;
    }

    body {
      background-color: #0f172a;
      color: #f8fafc;
    }

    /* Ensure dark mode is applied */
    html.dark {
      --c-bg: #0f172a;
      --c-text: #f8fafc;
    }
  </style>
  <body
    class="bg-slate-950 text-slate-50 font-sans min-h-screen flex flex-col overflow-x-hidden selection:bg-indigo-500/30"
  >
    <!-- Skip to content link for accessibility -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-purple-600 focus:text-white focus:rounded-md focus:shadow-lg transition-transform"
    >
      Skip to content
    </a>

    <ErrorBoundary>
      {
        showHeader && (
          <Header
            showThemeToggle={showThemeToggle}
            showUserMenu={showUserMenu}
            position="sticky"
          />
        )
      }

      <div class="flex flex-grow flex-col lg:flex-row">
        {
          showSidebar && (
            <aside
              class="sidebar dashboard-sidebar fixed inset-y-0 z-20 flex-shrink-0 w-64 pt-16
            transform transition-transform duration-300 lg:translate-x-0 lg:static lg:h-auto"
              id="sidebar"
              style="background: var(--bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-right: 1px solid var(--border-primary);"
            >
              <Sidebar />
            </aside>
          )
        }

        <main
          class:list={[
            'relative flex-grow pt-16 transition-all duration-300 ease-in-out slide-enter',
            showSidebar ? 'lg:ml-64' : 'w-full',
            contentClassName,
          ]}
          id="main-content"
        >
          <div
            class="container mx-auto px-4 py-6 min-h-[calc(100vh-4rem)] flex flex-col slide-enter-content"
          >
            <slot />
          </div>

          {
            showFooter && (
              <Footer
                showSocialLinks={showSocialLinks}
                className="mt-auto border-t border-border/30 backdrop-blur-sm"
              />
            )
          }
        </main>
      </div>
    </ErrorBoundary>

    <!-- Theme handling script with improved performance -->
    <script is:inline nonce={cspNonce}>
      // Get saved theme or use system default
      const getTheme = () => {
        const savedTheme = localStorage?.getItem('theme')
        if (savedTheme && ['light', 'dark', 'system'].includes(savedTheme)) {
          return savedTheme
        }
        return 'system'
      }

      // Apply theme
      const applyTheme = (theme) => {
        const isDark =
          theme === 'dark' ||
          (theme === 'system' &&
            window.matchMedia('(prefers-color-scheme: dark)').matches)

        document.documentElement.classList.toggle('dark', isDark)
      }

      // Initialize theme
      applyTheme(getTheme())

      // Listen for OS theme changes
      window
        .matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change', (event) => {
          const theme = getTheme()
          if (theme === 'system') {
            applyTheme('system')
          }
        })
    </script>
  </body>
</html>

<style>
  /* Custom scrollbar that matches antfu style */
  ::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  ::-webkit-scrollbar-track {
    background: transparent;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--c-scrollbar, #eee);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: var(--c-scrollbar-hover, #bbb);
  }

  /* Selection styling */
  ::selection {
    background: var(--c-selection, rgba(125, 125, 255, 0.2));
  }

  /* Mobile sidebar handling with improved transitions */
  @media (max-width: 1024px) {
    #sidebar {
      @apply -translate-x-full;
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #sidebar.active {
      @apply translate-x-0;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }
  }

  /* Clean fade in animation for content */
  main {
    opacity: 0;
    animation: fade-in 0.4s forwards;
  }

  @keyframes fade-in {
    to {
      opacity: 1;
    }
  }
</style>
