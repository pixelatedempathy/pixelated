# Environment-specific configurations for GitLab CI/CD
# Development, staging, and production environment settings

.variables:
  # Global variables
  NODE_VERSION: "24"
  PNPM_VERSION: "10.23.0"
  PYTHON_VERSION: "3.11"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  GIT_DEPTH: 0
  GIT_STRATEGY: fetch

# Development environment
.development:
  variables:
    ENVIRONMENT_NAME: development
    ENVIRONMENT_URL: "https://dev.pixelatedempathy.tech"
    KUBE_NAMESPACE: "pixelated-dev"
    REPLICAS: "1"
    MAX_SURGE: "1"
    MAX_UNAVAILABLE: "0"
    CANARY_PERCENTAGE: "10"
    ROLLBACK_THRESHOLD: "10"
    HEALTH_CHECK_TIMEOUT: "120"
    DEPLOYMENT_STRATEGY: "rolling"
    AUTO_ROLLBACK: "true"
    MONITORING_ENABLED: "true"
    LOG_LEVEL: "debug"
    CACHE_VERSION: "dev-v1"
  environment:
    name: development
    url: "https://dev.pixelatedempathy.tech"
    kubernetes:
      namespace: pixelated-dev
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
    - if: $CI_COMMIT_BRANCH =~ /^develop/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Staging environment
.staging:
  variables:
    ENVIRONMENT_NAME: staging
    ENVIRONMENT_URL: "https://staging.pixelatedempathy.tech"
    KUBE_NAMESPACE: "pixelated-staging"
    REPLICAS: "2"
    MAX_SURGE: "1"
    MAX_UNAVAILABLE: "0"
    CANARY_PERCENTAGE: "25"
    ROLLBACK_THRESHOLD: "5"
    HEALTH_CHECK_TIMEOUT: "300"
    DEPLOYMENT_STRATEGY: "rolling"
    AUTO_ROLLBACK: "true"
    MONITORING_ENABLED: "true"
    LOG_LEVEL: "info"
    CACHE_VERSION: "staging-v1"
  environment:
    name: staging
    url: "https://staging.pixelatedempathy.tech"
    kubernetes:
      namespace: pixelated-staging
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+-rc\./

# Production environment
.production:
  variables:
    ENVIRONMENT_NAME: production
    ENVIRONMENT_URL: "https://pixelatedempathy.tech"
    KUBE_NAMESPACE: "pixelated-production"
    REPLICAS: "3"
    MAX_SURGE: "1"
    MAX_UNAVAILABLE: "0"
    CANARY_PERCENTAGE: "10"
    ROLLBACK_THRESHOLD: "2"
    HEALTH_CHECK_TIMEOUT: "600"
    DEPLOYMENT_STRATEGY: "canary"
    AUTO_ROLLBACK: "true"
    MONITORING_ENABLED: "true"
    LOG_LEVEL: "warn"
    CACHE_VERSION: "prod-v1"
  environment:
    name: production
    url: "https://pixelatedempathy.tech"
    kubernetes:
      namespace: pixelated-production
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# Environment-specific deployment configurations
deploy:development:
  extends: .development
  stage: deploy
  image: google/cloud-sdk:alpine
  needs: ["build", "security-scan"]
  script:
    - echo "üöÄ Deploying to development environment..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "Namespace: $KUBE_NAMESPACE"
    - echo "Strategy: $DEPLOYMENT_STRATEGY"
    - echo "Replicas: $REPLICAS"
    
    # Authenticate to GKE
    - echo $GCP_SERVICE_ACCOUNT_KEY > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
    
    # Apply development-specific configurations
    - echo "üìã Applying development configurations..."
    - kubectl apply -f k8s/development/ -n ${KUBE_NAMESPACE} || true
    
    # Deploy with development settings
    - echo "üîÑ Deploying with development settings..."
    - helm upgrade --install pixelated-dev ./helm/pixelated \
      --namespace ${KUBE_NAMESPACE} \
      --set image.repository=${IMAGE_NAME} \
      --set image.tag=${CI_COMMIT_SHORT_SHA} \
      --set replicaCount=${REPLICAS} \
      --set resources.requests.memory="256Mi" \
      --set resources.requests.cpu="100m" \
      --set resources.limits.memory="512Mi" \
      --set resources.limits.cpu="200m" \
      --set environment=${ENVIRONMENT_NAME} \
      --set logLevel=${LOG_LEVEL} \
      --set monitoring.enabled=${MONITORING_ENABLED}
    
    - echo "‚úÖ Development deployment completed"
  environment:
    name: development
    url: "https://dev.pixelatedempathy.tech"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
    - if: $CI_COMMIT_BRANCH =~ /^develop/

deploy:staging:
  extends: .staging
  stage: deploy
  image: google/cloud-sdk:alpine
  needs: ["build", "security-scan", "compliance:summary"]
  script:
    - echo "üöÄ Deploying to staging environment..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "Namespace: $KUBE_NAMESPACE"
    - echo "Strategy: $DEPLOYMENT_STRATEGY"
    - echo "Replicas: $REPLICAS"
    
    # Authenticate to GKE
    - echo $GCP_SERVICE_ACCOUNT_KEY > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
    
    # Apply staging-specific configurations
    - echo "üìã Applying staging configurations..."
    - kubectl apply -f k8s/staging/ -n ${KUBE_NAMESPACE} || true
    
    # Deploy with staging settings
    - echo "üîÑ Deploying with staging settings..."
    - helm upgrade --install pixelated-staging ./helm/pixelated \
      --namespace ${KUBE_NAMESPACE} \
      --set image.repository=${IMAGE_NAME} \
      --set image.tag=${CI_COMMIT_SHORT_SHA} \
      --set replicaCount=${REPLICAS} \
      --set resources.requests.memory="512Mi" \
      --set resources.requests.cpu="200m" \
      --set resources.limits.memory="1Gi" \
      --set resources.limits.cpu="500m" \
      --set environment=${ENVIRONMENT_NAME} \
      --set logLevel=${LOG_LEVEL} \
      --set monitoring.enabled=${MONITORING_ENABLED} \
      --set autoscaling.enabled=true \
      --set autoscaling.minReplicas=2 \
      --set autoscaling.maxReplicas=5
    
    - echo "‚úÖ Staging deployment completed"
  environment:
    name: staging
    url: "https://staging.pixelatedempathy.tech"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

deploy:production:
  extends: .production
  stage: deploy
  image: google/cloud-sdk:alpine
  needs: ["build", "security-scan", "compliance:summary"]
  script:
    - echo "üöÄ Deploying to production environment..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "Namespace: $KUBE_NAMESPACE"
    - echo "Strategy: $DEPLOYMENT_STRATEGY"
    - echo "Replicas: $REPLICAS"
    
    # Pre-deployment validation
    - echo "üîç Running pre-deployment validation..."
    - . ./scripts/pre-deployment-checks.sh
    
    # Authenticate to GKE
    - echo $GCP_SERVICE_ACCOUNT_KEY > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
    
    # Apply production-specific configurations
    - echo "üìã Applying production configurations..."
    - kubectl apply -f k8s/production/ -n ${KUBE_NAMESPACE} || true
    
    # Deploy with production settings using canary strategy
    - echo "üîÑ Deploying with production settings..."
    - case $DEPLOYMENT_STRATEGY in
        canary)
          echo "üê§ Using canary deployment strategy";
          . ./scripts/deploy-canary.sh;
          ;;
        blue-green)
          echo "üîÑ Using blue-green deployment strategy";
          . ./scripts/deploy-blue-green.sh;
          ;;
        rolling)
          echo "üîÑ Using rolling deployment strategy";
          . ./scripts/deploy-rolling.sh;
          ;;
        *)
          echo "‚ùå Unknown deployment strategy: $DEPLOYMENT_STRATEGY";
          exit 1;
          ;;
      esac
    
    - echo "‚úÖ Production deployment completed"
  environment:
    name: production
    url: "https://pixelatedempathy.tech"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# Environment-specific health checks
health-check:development:
  extends: .development
  stage: health-check
  needs: ["deploy:development"]
  script:
    - echo "üè• Running development health checks..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "URL: $ENVIRONMENT_URL"
    
    # Basic health check
    - HEALTH_RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null "$ENVIRONMENT_URL/api/health" || echo "000")
    - if [ "$HEALTH_RESPONSE" = "200" ]; then
        echo "‚úÖ Development environment is healthy";
      else
        echo "‚ùå Development health check failed: $HEALTH_RESPONSE";
        exit 1;
      fi
    
    - echo "‚úÖ Development health checks completed"

health-check:staging:
  extends: .staging
  stage: health-check
  needs: ["deploy:staging"]
  script:
    - echo "üè• Running staging health checks..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "URL: $ENVIRONMENT_URL"
    
    # Comprehensive health checks
    - . ./scripts/health-check-comprehensive.sh
    
    - echo "‚úÖ Staging health checks completed"

health-check:production:
  extends: .production
  stage: health-check
  needs: ["deploy:production"]
  script:
    - echo "üè• Running production health checks..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "URL: $ENVIRONMENT_URL"
    
    # Production-grade health checks
    - . ./scripts/health-check-comprehensive.sh
    
    # Performance validation
    - . ./scripts/validate-canary-performance.sh
    
    - echo "‚úÖ Production health checks completed"

# Environment cleanup
cleanup:development:
  extends: .development
  stage: cleanup
  when: manual
  script:
    - echo "üßπ Cleaning up development environment..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "Namespace: $KUBE_NAMESPACE"
    
    # Cleanup old deployments
    - kubectl delete deployment -n ${KUBE_NAMESPACE} -l app=pixelated,version!=${CI_COMMIT_SHORT_SHA}
    
    # Cleanup old services
    - kubectl delete service -n ${KUBE_NAMESPACE} -l app=pixelated,version!=${CI_COMMIT_SHORT_SHA}
    
    - echo "‚úÖ Development cleanup completed"
  environment:
    name: development
    action: stop

cleanup:staging:
  extends: .staging
  stage: cleanup
  when: manual
  script:
    - echo "üßπ Cleaning up staging environment..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "Namespace: $KUBE_NAMESPACE"
    
    # Cleanup old deployments
    - kubectl delete deployment -n ${KUBE_NAMESPACE} -l app=pixelated,version!=${CI_COMMIT_SHORT_SHA}
    
    # Cleanup old services
    - kubectl delete service -n ${KUBE_NAMESPACE} -l app=pixelated,version!=${CI_COMMIT_SHORT_SHA}
    
    - echo "‚úÖ Staging cleanup completed"
  environment:
    name: staging
    action: stop

cleanup:production:
  extends: .production
  stage: cleanup
  when: manual
  script:
    - echo "üßπ Cleaning up production environment..."
    - echo "Environment: $ENVIRONMENT_NAME"
    - echo "Namespace: $KUBE_NAMESPACE"
    
    # Production cleanup with extra caution
    - echo "‚ö†Ô∏è Production cleanup requires manual approval"
    - echo "This will remove old deployments and services"
    
    # Cleanup old deployments (keep last 2)
    - kubectl get deployments -n ${KUBE_NAMESPACE} -l app=pixelated --sort-by=.metadata.creationTimestamp
    - echo "Review deployments above before cleanup"
    
    - echo "‚úÖ Production cleanup review completed"
  environment:
    name: production
    action: stop