# Security and compliance pipeline configuration
# Extended security scanning and compliance validation

.security-base:
  stage: security
  image: node:${NODE_VERSION}-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl git > /dev/null
    - corepack enable pnpm

# Advanced security scanning
security:advanced:
  extends: .security-base
  needs: ["build"]
  script:
    - echo "üîí Running advanced security scanning..."
    
    # Install security tools
    - npm install -g @cyclonedx/cyclonedx-npm
    - npm install -g retire
    
    # Generate SBOM (Software Bill of Materials)
    - echo "üìã Generating SBOM..."
    - cyclonedx-npm --output-format json --output-file sbom.json
    - echo "‚úÖ SBOM generated"
    
    # Dependency vulnerability scanning
    - echo "üîç Scanning dependencies for vulnerabilities..."
    - retire --outputformat json --outputpath retire-report.json || true
    
    # Secrets detection
    - echo "üîç Detecting secrets..."
    - pnpm install --no-save detect-secrets
    - npx detect-secrets scan --all-files --baseline .secrets.baseline
    
    # License compliance check
    - echo "üìã Checking license compliance..."
    - npx license-checker --json --out license-report.json
    
    - echo "‚úÖ Advanced security scanning completed"
  artifacts:
    reports:
      dependency_scanning: sbom.json
      license_scanning: license-report.json
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# HIPAA compliance validation
security:hipaa:
  extends: .security-base
  needs: ["build"]
  script:
    - echo "üè• Running HIPAA compliance validation..."
    
    # Check for HIPAA-specific security requirements
    - echo "üîç Validating encryption requirements..."
    - grep -r "aes-256-gcm" src/ || echo "‚ö†Ô∏è AES-256-GCM encryption not found"
    
    - echo "üîç Checking access controls..."
    - grep -r "authentication" src/ || echo "‚ö†Ô∏è Authentication controls not found"
    
    - echo "üîç Validating audit controls..."
    - grep -r "audit" src/ || echo "‚ö†Ô∏è Audit controls not found"
    
    - echo "üîç Checking data integrity..."
    - grep -r "integrity" src/ || echo "‚ö†Ô∏è Data integrity controls not found"
    
    - echo "üîç Validating transmission security..."
    - grep -r "tls\|ssl" src/ || echo "‚ö†Ô∏è Transmission security not found"
    
    # Run specialized HIPAA compliance tests
    - echo "üèÉ Running HIPAA compliance tests..."
    - pnpm run test:hipaa || echo "‚ö†Ô∏è HIPAA tests failed"
    
    - echo "‚úÖ HIPAA compliance validation completed"
  artifacts:
    reports:
      junit: test-results/hipaa-junit.xml
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Mental health data protection validation
security:mental-health:
  extends: .security-base
  needs: ["build"]
  script:
    - echo "üß† Running mental health data protection validation..."
    
    # Crisis intervention data security
    - echo "üîç Validating crisis intervention data security..."
    - grep -r "crisis" src/ || echo "‚ö†Ô∏è Crisis intervention handling not found"
    
    # Bias detection input sanitization
    - echo "üîç Checking bias detection input sanitization..."
    - grep -r "sanitize\|validate" src/lib/ai/bias-detection/ || echo "‚ö†Ô∏è Input sanitization not found"
    
    # FHE implementation validation
    - echo "üîç Validating FHE implementation..."
    - grep -r "fhe\|homomorphic" src/ || echo "‚ö†Ô∏è FHE implementation not found"
    
    # Data anonymization capabilities
    - echo "üîç Checking data anonymization..."
    - grep -r "anonymize\|pseudonymize" src/ || echo "‚ö†Ô∏è Data anonymization not found"
    
    # Secure communication channels
    - echo "üîç Validating secure communication..."
    - grep -r "secure\|encrypted" src/ || echo "‚ö†Ô∏è Secure communication not found"
    
    - echo "‚úÖ Mental health data protection validation completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Static code analysis
security:static-analysis:
  extends: .security-base
  needs: ["build"]
  script:
    - echo "üîç Running static code analysis..."
    
    # ESLint security rules
    - echo "üîç Running ESLint security analysis..."
    - pnpm run lint:ci || echo "‚ö†Ô∏è ESLint security issues found"
    
    # TypeScript security checks
    - echo "üîç Running TypeScript security checks..."
    - pnpm run typecheck:strict || echo "‚ö†Ô∏è TypeScript security issues found"
    
    # Custom security patterns
    - echo "üîç Checking for security patterns..."
    - grep -r "eval\|Function\|setTimeout\|setInterval" src/ || echo "‚úÖ No dangerous patterns found"
    
    # Input validation checks
    - echo "üîç Validating input handling..."
    - grep -r "validate\|sanitize" src/ || echo "‚ö†Ô∏è Input validation not comprehensive"
    
    - echo "‚úÖ Static code analysis completed"
  artifacts:
    reports:
      codequality: eslint-report.json
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

# Container security validation
security:container:
  extends: .security-base
  needs: ["build"]
  services:
    - docker:dind
  script:
    - echo "üîç Running container security validation..."
    
    # Container image analysis
    - echo "üîç Analyzing container image..."
    - docker pull ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    
    # Check for known vulnerabilities
    - echo "üîç Checking for known vulnerabilities..."
    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock 
      aquasec/trivy image --severity HIGH,CRITICAL 
      ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} || echo "‚ö†Ô∏è Vulnerabilities found"
    
    # Container configuration validation
    - echo "üîç Validating container configuration..."
    - docker inspect ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} > container-inspect.json
    
    # Check security configurations
    - echo "üîç Checking security configurations..."
    - USER=$(jq -r '.[0].Config.User' container-inspect.json)
    - if [ "$USER" = "root" ] || [ "$USER" = "0" ]; then
        echo "‚ùå Container runs as root user";
        exit 1;
      else
        echo "‚úÖ Container runs as non-root user: $USER";
      fi
    
    # Check for unnecessary capabilities
    - CAPABILITIES=$(jq -r '.[0].HostConfig.CapAdd' container-inspect.json)
    - if [ "$CAPABILITIES" != "null" ]; then
        echo "‚ö†Ô∏è Container has added capabilities: $CAPABILITIES";
      fi
    
    - echo "‚úÖ Container security validation completed"
  artifacts:
    reports:
      container_scanning: container-inspect.json
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Security policy enforcement
security:policy:
  extends: .security-base
  needs: ["build"]
  script:
    - echo "üìã Enforcing security policies..."
    
    # Check security policy compliance
    - echo "üîç Checking security policy compliance..."
    - test -f security/security-policy.yaml || echo "‚ö†Ô∏è Security policy file not found"
    
    # Validate security configurations
    - echo "üîç Validating security configurations..."
    - test -f .checkov.yaml || echo "‚ö†Ô∏è Checkov configuration not found"
    
    # Check for security documentation
    - echo "üîç Checking security documentation..."
    - test -f security/pipeline-security.md || echo "‚ö†Ô∏è Security documentation not found"
    
    # Validate incident response procedures
    - echo "üîç Validating incident response procedures..."
    - test -f security/incident-response-procedures.md || echo "‚ö†Ô∏è Incident response procedures not found"
    
    - echo "‚úÖ Security policy enforcement completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG