name: Dependency Vulnerability Scan

permissions:
  contents: read

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
  - cron: '0 0 * * 0' # Run every Sunday at midnight

jobs:
  node_scan:
    name: Scan Node.js Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Install pnpm globally
      run: npm install -g pnpm@10.18.0

    - name: Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '24'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run pnpm audit
      run: pnpm audit --audit-level=moderate
      continue-on-error: true

  python_scan:
    name: Scan Python Dependencies
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install uv (force latest)
      run: pip install --upgrade 'uv>=0.8.6'

    - name: Install project dependencies with uv
      run: uv sync

    - name: Install pip-audit in the uv environment
      run: uv pip install pip-audit

    # Run pip-audit, excluding local editable package
    # Note: Ignoring pip vulnerability GHSA-4xh5-x5gv-qwph as it's not exploitable in CI
    # and is a transitive dependency managed by uv
    - name: Run pip-audit (skip editable/local package)
      run: uv run pip-audit --skip-editable --format=columns --ignore-vuln GHSA-4xh5-x5gv-qwph
