# GitLab CI/CD Pipeline for Pixelated Empathy
# Clean, simple, and working pipeline

stages:
  - validate
  - build
  - security
  - deploy
  - health-check
  - cleanup

variables:
  NODE_VERSION: "24"
  PNPM_VERSION: "10.23.0"
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  STAGING_URL: "https://staging.pixelatedempathy.tech"
  PRODUCTION_URL: "https://pixelatedempathy.tech"
  # GCP/GKE configuration - must be set as GitLab CI/CD project variables
  # Required for deployment and health-check jobs
  # If not configured, jobs will fail with clear error messages
  # Configure at: Settings > CI/CD > Variables
  # Note: GCP_PROJECT_ID, GKE_CLUSTER_NAME, GKE_ZONE, and GCP_SERVICE_ACCOUNT_KEY
  # are inherited directly from project variables and should not be redefined here

# Validation jobs
validate:dependencies:
  stage: validate
  image: node:${NODE_VERSION}-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 make g++ > /dev/null
    - corepack enable pnpm
  script:
    - echo "Validating dependencies..."
    - pnpm install --frozen-lockfile
    - pnpm audit --audit-level moderate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:lint:
  stage: validate
  image: node:${NODE_VERSION}-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 make g++ > /dev/null
    - corepack enable pnpm
  script:
    - echo "Running lint validation..."
    - pnpm install --frozen-lockfile
    - pnpm lint:ci
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:typecheck:
  stage: validate
  image: node:${NODE_VERSION}-slim
  variables:
    # Increase Node.js heap size to prevent OOM during typecheck
    # Astro check can be memory-intensive with large codebases
    NODE_OPTIONS: "--max-old-space-size=6144"
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 make g++ > /dev/null
    - corepack enable pnpm
  script:
    - echo "Running typecheck validation..."
    - pnpm install --frozen-lockfile
    - pnpm typecheck
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build job
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  needs: ["validate:dependencies", "validate:lint", "validate:typecheck"]
  before_script:
    # Validate Docker registry variables are set
    - |
      if [ -z "$CI_REGISTRY_USER" ] || [ -z "$CI_REGISTRY_PASSWORD" ] || [ -z "$CI_REGISTRY" ]; then
        echo "ERROR: Docker registry variables are not set."
        echo "GitLab CI/CD should provide these automatically, but if missing:"
        echo "  - CI_REGISTRY_USER"
        echo "  - CI_REGISTRY_PASSWORD"
        echo "  - CI_REGISTRY"
        echo "Check: Settings > CI/CD > Variables"
        exit 1
      fi
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building application..."
    - docker build -t ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} .
    - docker tag ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} ${IMAGE_NAME}:latest
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - docker push ${IMAGE_NAME}:latest
    - echo "Build completed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security scanning
security:scan:
  stage: security
  image: aquasec/trivy:latest
  services:
    - docker:dind
  needs: ["build"]
  before_script:
    # Validate Docker registry variables are set
    - |
      if [ -z "$CI_REGISTRY_USER" ] || [ -z "$CI_REGISTRY_PASSWORD" ] || [ -z "$CI_REGISTRY" ]; then
        echo "ERROR: Docker registry variables are not set."
        echo "GitLab CI/CD should provide these automatically, but if missing:"
        echo "  - CI_REGISTRY_USER"
        echo "  - CI_REGISTRY_PASSWORD"
        echo "  - CI_REGISTRY"
        echo "Check: Settings > CI/CD > Variables"
        exit 1
      fi
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Running security scan..."
    - docker pull ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - trivy image --severity CRITICAL,HIGH --exit-code 0 ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}
    - echo "Security scan completed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deployment to staging
deploy:staging:
  stage: deploy
  image: google/cloud-sdk:alpine
  needs: ["build", "security:scan"]
  before_script:
    # Validate required GCP/GKE variables are set
    - |
      if [ -z "$GCP_PROJECT_ID" ] || [ -z "$GKE_CLUSTER_NAME" ] || [ -z "$GKE_ZONE" ] || [ -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then
        echo "ERROR: Required GCP/GKE variables are not set."
        echo "Please configure the following GitLab CI/CD project variables:"
        echo "  - GCP_PROJECT_ID"
        echo "  - GKE_CLUSTER_NAME"
        echo "  - GKE_ZONE"
        echo "  - GCP_SERVICE_ACCOUNT_KEY"
        echo "See: Settings > CI/CD > Variables"
        exit 1
      fi
    - echo "$GCP_SERVICE_ACCOUNT_KEY" > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
  script:
    - echo "Deploying to staging..."
    # Check if deployment exists, fail if not
    - |
      if kubectl get deployment pixelated -n pixelated-staging > /dev/null 2>&1; then
        echo "Updating existing deployment..."
        kubectl set image deployment/pixelated app=${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} -n pixelated-staging
      else
        echo "ERROR: Deployment 'pixelated' does not exist in namespace 'pixelated-staging'"
        echo "First deployment must be done manually or via infrastructure-as-code"
        echo "The deployment job cannot proceed without an existing deployment"
        exit 1
      fi
    - kubectl rollout status deployment/pixelated -n pixelated-staging --timeout=300s || echo "Rollout status check completed with warnings"
    - echo "Staging deployment completed"
  environment:
    name: staging
    url: $STAGING_URL
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Health check
health-check:
  stage: health-check
  image: google/cloud-sdk:alpine
  needs: ["deploy:staging"]
  before_script:
    # Validate required GCP/GKE variables are set
    - |
      if [ -z "$GCP_PROJECT_ID" ] || [ -z "$GKE_CLUSTER_NAME" ] || [ -z "$GKE_ZONE" ] || [ -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then
        echo "ERROR: Required GCP/GKE variables are not set."
        echo "Please configure the following GitLab CI/CD project variables:"
        echo "  - GCP_PROJECT_ID"
        echo "  - GKE_CLUSTER_NAME"
        echo "  - GKE_ZONE"
        echo "  - GCP_SERVICE_ACCOUNT_KEY"
        echo "See: Settings > CI/CD > Variables"
        exit 1
      fi
    - echo "$GCP_SERVICE_ACCOUNT_KEY" > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file /tmp/gcp-key.json
    - gcloud config set project $GCP_PROJECT_ID
    - gcloud container clusters get-credentials $GKE_CLUSTER_NAME --zone $GKE_ZONE --project $GCP_PROJECT_ID
  script:
    - echo "Running health checks..."
    - kubectl get pods -n pixelated-staging || echo "No pods found"
    - kubectl get deployment pixelated -n pixelated-staging || echo "Deployment not found"
    # Health check with retry logic
    - |
      MAX_RETRIES=3
      RETRY_COUNT=0
      HEALTH_CHECK_PASSED=false
      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        if curl -f -s "$STAGING_URL/api/health" > /dev/null; then
          echo "Health check passed"
          HEALTH_CHECK_PASSED=true
          break
        fi
        RETRY_COUNT=$((RETRY_COUNT + 1))
        if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
          echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
          sleep 5
        fi
      done
      if [ "$HEALTH_CHECK_PASSED" = "false" ]; then
        echo "WARNING: Health check failed after $MAX_RETRIES attempts"
      fi
    - echo "Health check completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Performance test
performance-test:
  stage: health-check
  image: node:${NODE_VERSION}-slim
  needs: ["deploy:staging"]
  before_script:
    - apt-get update -qq && apt-get install -y -qq python3 make g++ > /dev/null
    - corepack enable pnpm
  script:
    - echo "Running performance tests..."
    - pnpm install --frozen-lockfile
    - pnpm run performance:test
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# E2E test
e2e-test:
  stage: health-check
  image: mcr.microsoft.com/playwright:v1.56.1-jammy
  needs: ["deploy:staging"]
  before_script:
    - corepack enable pnpm
  script:
    - echo "Running E2E tests..."
    - pnpm install --frozen-lockfile
    - pnpm run e2e:smoke
  artifacts:
    reports:
      junit: test-results/junit.xml
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
