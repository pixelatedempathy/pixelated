---
import { initializeApplication, shutdownApplication } from '../lib/startup'

// Simple function to safely log during build/runtime
function safeLog(level: 'info' | 'error', message: string, data?: unknown) {
  const timestamp = new Date().toISOString()
  const prefix = '[phi-audit]'

  if (level === 'error') {
    console.error(
      `${timestamp} ERROR ${prefix} ${message}`,
      data ? JSON.stringify(data, null, 2) : '',
    )
  } else {
    console.info(
      `${timestamp} INFO ${prefix} ${message}`,
      data ? JSON.stringify(data, null, 2) : '',
    )
  }
}

// Execute startup logic in Astro's server context
if (import.meta.env.SSR) {
  try {
    await initializeApplication()
    safeLog('info', 'Application started successfully')

    // Register shutdown handlers for the Node.js process
    // Note: Only works in Node.js runtime (not Cloudflare Workers)
    // Cloudflare Workers runtime doesn't have process.on()
    if (typeof process !== 'undefined' && process.on) {
      process.on('SIGTERM', handleShutdown)
      process.on('SIGINT', handleShutdown)
    } else {
      safeLog('info', 'Running in Cloudflare Workers runtime - process handlers not available')
    }
  } catch (error) {
    safeLog(
      'error',
      'Failed to start application',
      error instanceof Error
        ? { message: error.message, stack: error.stack }
        : undefined,
    )
    // Cannot exit the process in Astro middleware, log the error instead
    console.error('Application failed to start properly')
  }
}

/**
 * Handle graceful shutdown
 * Note: Only works in Node.js runtime, not Cloudflare Workers
 */
async function handleShutdown() {
  safeLog('info', 'Shutdown signal received, gracefully shutting down...')

  try {
    await shutdownApplication()
    safeLog('info', 'Application shutdown complete')
    if (typeof process !== 'undefined' && process.exit) {
      process.exit(0)
    }
  } catch (error) {
    safeLog(
      'error',
      'Error during shutdown',
      error instanceof Error
        ? { message: error.message, stack: error.stack }
        : undefined,
    )
    if (typeof process !== 'undefined' && process.exit) {
      process.exit(1)
    }
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Application</title>
  </head>
  <body>
    <main>
      <h1>Application Status</h1>
      <p>The server-side application has been initialized.</p>
    </main>
  </body>
</html>
