---
# Security and compliance pipeline configuration
# Extended security scanning and compliance validation

.security-base:
  stage: security
  image: node:${NODE_VERSION}-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl git > /dev/null
    - corepack enable pnpm

# Advanced security scanning
security:advanced:
  extends: .security-base
  needs: ["build"]
  script:
    - echo " Running advanced security scanning..."

    # Install security tools
    - npm install -g @cyclonedx/cyclonedx-npm
    - npm install -g retire

    # Generate SBOM (Software Bill of Materials)
    - echo " Generating SBOM..."
    - cyclonedx-npm --output-format json --output-file sbom.json
    - echo " SBOM generated"

    # Dependency vulnerability scanning
    - echo " Scanning dependencies for vulnerabilities..."
    - retire --outputformat json --outputpath retire-report.json || true

    # Secrets detection
    - echo " Detecting secrets..."
    - pnpm install --no-save detect-secrets
    - npx detect-secrets scan --all-files --baseline .secrets.baseline

    # License compliance check
    - echo " Checking license compliance..."
    - npx license-checker --json --out license-report.json

    - echo " Advanced security scanning completed"
  artifacts:
    reports:
      dependency_scanning: sbom.json
      license_scanning: license-report.json
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# HIPAA compliance validation
security:hipaa:
  extends: .security-base
  needs: ["build"]
  script:
    - echo " Running HIPAA compliance validation..."

    # Check for HIPAA-specific security requirements
    - echo " Validating encryption requirements..."
    - |
      grep -r "aes-256-gcm" \
        src/ \
        || echo 'WARNING: AES-256-GCM encryption not found'

    - echo " Checking access controls..."
    - |
      grep -r "authentication" \
        src/ \
        || echo 'WARNING: Authentication controls not found'

    - echo " Validating audit controls..."
    - |
      grep -r "audit" \
        src/ \
        || echo 'WARNING: Audit controls not found'

    - echo " Checking data integrity..."
    - |
      grep -r "integrity" \
        src/ \
        || echo 'WARNING: Data integrity controls not found'

    - echo " Validating transmission security..."
    - |
      grep -r "tls\|ssl" \
        src/ \
        || echo 'WARNING: Transmission security not found'

    # Run specialized HIPAA compliance tests
    - echo " Running HIPAA compliance tests..."
    - |
      pnpm run test:hipaa || echo 'WARNING: HIPAA tests failed'

    - echo " HIPAA compliance validation completed"
  artifacts:
    reports:
      junit: test-results/hipaa-junit.xml
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Mental health data protection validation
security:mental-health:
  extends: .security-base
  needs: ["build"]
  script:
    - echo " Running mental health data protection validation..."

    # Crisis intervention data security
    - echo " Validating crisis intervention data security..."
    - |
      grep -r "crisis" \
        src/ \
        || echo 'WARNING: Crisis intervention handling not found'

    # Bias detection input sanitization
    - echo " Checking bias detection input sanitization..."
    - |
      grep -r "sanitize\|validate" \
        src/lib/ai/bias-detection/ \
        || echo 'WARNING: Input sanitization not found'

    # FHE implementation validation
    - echo " Validating FHE implementation..."
    - |
      grep -r "fhe\|homomorphic" \
        src/ \
        || echo 'WARNING: FHE implementation not found'

    # Data anonymization capabilities
    - echo " Checking data anonymization..."
    - |
      grep -r "anonymize\|pseudonymize" \
        src/ \
        || echo 'WARNING: Data anonymization not found'

    # Secure communication channels
    - echo " Validating secure communication..."
    - |
      grep -r "secure\|encrypted" \
        src/ \
        || echo 'WARNING: Secure communication not found'

    - echo " Mental health data protection validation completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Static code analysis
security:static-analysis:
  extends: .security-base
  needs: ["build"]
  script:
    - echo " Running static code analysis..."

    # ESLint security rules
    - echo " Running ESLint security analysis..."
    - pnpm run lint:ci || echo "WARNING: ESLint security issues found"

    # TypeScript security checks
    - echo " Running TypeScript security checks..."
    - pnpm run typecheck:strict || echo "WARNING: TypeScript security issues found"

    # Custom security patterns
    - echo " Checking for security patterns..."
    - |
      grep -r "eval\|Function\|setTimeout\|setInterval" \
        src/ \
        || echo " No dangerous patterns found"

    # Input validation checks
    - echo " Validating input handling..."
    - |
      grep -r "validate\|sanitize" \
        src/ \
        || echo "WARNING: Input validation not comprehensive"

    - echo " Static code analysis completed"
  artifacts:
    reports:
      codequality: eslint-report.json
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/

# Container security validation
security:container:
  extends: .security-base
  needs: ["build"]
  services:
    - docker:dind
  script:
    - echo " Running container security validation..."

    # Container image analysis
    - echo " Analyzing container image..."
    - docker pull ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}

    # Check for known vulnerabilities
    - echo " Checking for known vulnerabilities..."
    - |
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy image \
        --severity HIGH,CRITICAL \
        ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} || echo 'WARNING: Vulnerabilities found'

    # Container configuration validation
    - echo " Validating container configuration..."
    - |
      docker inspect ${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA} \
        > container-inspect.json

    # Check security configurations
    - echo " Checking security configurations..."
    - USER=$(jq -r '.[0].Config.User' container-inspect.json)
    - |
      if [ "$USER" = "root" ] || [ "$USER" = "0" ]; then
        echo 'ERROR: Container runs as root user'
        exit 1
      else
        echo ' Container runs as non-root user: $USER'
      fi

    # Check for unnecessary capabilities
    - CAPABILITIES=$(jq -r '.[0].HostConfig.CapAdd' container-inspect.json)
    - |
      if [ "$CAPABILITIES" != "null" ]; then
        echo 'WARNING: Container has added capabilities: $CAPABILITIES'
      fi

    - echo " Container security validation completed"
  artifacts:
    reports:
      container_scanning: container-inspect.json
    expire_in: 1 week
    when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Security policy enforcement
security:policy:
  extends: .security-base
  needs: ["build"]
  script:
    - echo " Enforcing security policies..."

    # Check security policy compliance
    - echo " Checking security policy compliance..."
    - |
      test -f security/security-policy.yaml \
        || echo 'WARNING: Security policy file not found'

    # Validate security configurations
    - echo " Validating security configurations..."
    - |
      test -f .checkov.yaml \
        || echo 'WARNING: Checkov configuration not found'

    # Check for security documentation
    - echo " Checking security documentation..."
    - |
      test -f security/pipeline-security.md \
        || echo 'WARNING: Security documentation not found'

    # Validate incident response procedures
    - echo " Validating incident response procedures..."
    - |
      test -f security/incident-response-procedures.md \
        || echo 'WARNING: Incident response procedures not found'

    - echo " Security policy enforcement completed"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG
