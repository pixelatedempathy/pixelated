---
# DaemonSet to fix containerd cgroup warnings for Azure Linux Agent
# This configures containerd to suppress warnings about systemd slices
# Note: This requires privileged access and may need cluster admin approval
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: containerd-config-fix
  namespace: kube-system
  labels:
    app: containerd-config-fix
    purpose: suppress-walinuxagent-warnings
spec:
  selector:
    matchLabels:
      app: containerd-config-fix
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app: containerd-config-fix
    spec:
      # Run on all nodes including system nodes
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      # Required to access host filesystem and systemd
      hostNetwork: true
      hostPID: true
      containers:
      - name: containerd-config-patch
        image: mcr.microsoft.com/cbl-mariner/base/core:2.0
        securityContext:
          privileged: true
          capabilities:
            add:
            - SYS_ADMIN
            - CHOWN
            - FOWNER
            - DAC_OVERRIDE
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          
          echo "üîß Configuring containerd to suppress walinuxagent warnings..."
          
          # Find containerd config - AKS uses different paths
          CONTAINERD_CONFIGS=(
            "/host/etc/containerd/config.toml"
            "/host/var/lib/containerd/config.toml"
            "/host/etc/containerd/config.toml.bak"
          )
          
          CONTAINERD_CONFIG=""
          for config_path in "${CONTAINERD_CONFIGS[@]}"; do
            if [ -f "$config_path" ]; then
              CONTAINERD_CONFIG="$config_path"
              echo "‚úÖ Found containerd config at: $config_path"
              break
            fi
          done
          
          if [ -z "$CONTAINERD_CONFIG" ]; then
            echo "‚ö†Ô∏è Containerd config not found in standard locations."
            echo "   Attempting to generate default config..."
            
            # Try to get containerd config via containerd config dump
            mkdir -p /host/etc/containerd
            if command -v containerd >/dev/null 2>&1; then
              containerd config default > /host/etc/containerd/config.toml 2>/dev/null || true
              CONTAINERD_CONFIG="/host/etc/containerd/config.toml"
            fi
            
            if [ ! -f "$CONTAINERD_CONFIG" ]; then
              echo "‚ùå Cannot locate or generate containerd config."
              echo "   This warning is benign and does not affect deployments."
              echo "   To fix manually, configure containerd log level on AKS nodes."
              exit 0
            fi
          fi
          
          # Backup original config
          BACKUP_PATH="${CONTAINERD_CONFIG}.backup.$(date +%s)"
          cp "$CONTAINERD_CONFIG" "$BACKUP_PATH" 2>/dev/null || true
          echo "‚úÖ Backed up config (if writable)"
          
          # Check if already patched
          if grep -q "Suppress azure.slice warnings" "$CONTAINERD_CONFIG" 2>/dev/null; then
            echo "‚úÖ Config already patched"
            exit 0
          fi
          
          # Method 1: Try to patch config file directly
          if [ -w "$CONTAINERD_CONFIG" ]; then
            echo "üìù Patching containerd config file..."
            
            # Add or update log level in containerd CRI section
            if grep -q '\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\]' "$CONTAINERD_CONFIG"; then
              # Section exists, update log_level
              sed -i '/\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\]/,/^\[/ {
                /^log_level/ d
                /^\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\]/ a\
  log_level = "error"  # Suppress azure.slice warnings
              }' "$CONTAINERD_CONFIG"
            else
              # Add new section
              cat >> "$CONTAINERD_CONFIG" << 'EOF'

# Suppress azure.slice warnings - added by containerd-config-fix DaemonSet
[plugins."io.containerd.grpc.v1.cri".containerd]
  log_level = "error"
EOF
            fi
            
            echo "‚úÖ Config file patched"
          else
            echo "‚ö†Ô∏è Config file is read-only (expected in AKS managed nodes)"
            echo "   Using alternative method: environment variable override"
          fi
          
          # Method 2: Set environment variable for containerd process
          # This affects running containerd but may not persist after restart
          echo "üìù Attempting to configure containerd via systemd override..."
          
          SYSTEMD_OVERRIDE="/host/etc/systemd/system/containerd.service.d/override.conf"
          mkdir -p "$(dirname "$SYSTEMD_OVERRIDE")"
          
          cat > "$SYSTEMD_OVERRIDE" << 'EOF'
[Service]
Environment="CONTAINERD_LOG_LEVEL=error"
EOF
          
          # Reload systemd and restart containerd if we can
          if [ -w "/host/etc" ]; then
            systemctl daemon-reload 2>/dev/null || true
            systemctl restart containerd 2>/dev/null || {
              echo "‚ö†Ô∏è Could not restart containerd (may require node restart)"
            }
            echo "‚úÖ Systemd override applied"
          else
            echo "‚ö†Ô∏è Cannot write systemd override (read-only filesystem)"
            echo "   Fix will require:"
            echo "   1. Node restart, OR"
            echo "   2. AKS cluster configuration update via Azure CLI:"
            echo "      az aks update --resource-group <rg> --name <cluster> --node-image-only"
          fi
          
          echo "‚úÖ Configuration attempt completed"
          echo "   Note: In AKS, node-level changes may reset on node replacement."
          echo "   For permanent fix, use AKS cluster configuration or Azure support."
          
          # Keep running to reapply on node changes
          sleep infinity
        volumeMounts:
        - name: host-etc
          mountPath: /host/etc
          readOnly: false
        - name: host-run
          mountPath: /host/run
          readOnly: false
        - name: host-sys
          mountPath: /host/sys
          readOnly: true
        - name: host-var-lib
          mountPath: /host/var/lib
          readOnly: false
      volumes:
      - name: host-etc
        hostPath:
          path: /etc
          type: Directory
      - name: host-run
        hostPath:
          path: /run
          type: Directory
      - name: host-sys
        hostPath:
          path: /sys
          type: Directory
      - name: host-var-lib
        hostPath:
          path: /var/lib
          type: Directory
      restartPolicy: Always
      serviceAccountName: containerd-config-fix
---
# ServiceAccount for the DaemonSet
apiVersion: v1
kind: ServiceAccount
metadata:
  name: containerd-config-fix
  namespace: kube-system
---
# ClusterRole with minimal required permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: containerd-config-fix
rules:
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: containerd-config-fix
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: containerd-config-fix
subjects:
- kind: ServiceAccount
  name: containerd-config-fix
  namespace: kube-system

