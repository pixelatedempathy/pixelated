---
import "@unocss/reset/tailwind.css";
import "@/styles/main.css";
import "@/styles/prose.css";
import "@/styles/markdown.css";
import "@/styles/page.css";
import SpeedInsights from "@vercel/speed-insights/astro";

import Head from "@/components/base/Head.astro";
import Background from "@/components/backgrounds/Background.astro";
import Link from "@/components/base/Link.astro";
import Navbar from "@/components/mizu/Navbar.astro";
import BackLink from "@/components/widgets/BackLink.astro";
import Footer from "@/components/mizu/Footer.astro";
import ToTopButton from "@/components/widgets/ToTopButton.astro";
import Backdrop from "@/components/base/Backdrop.astro";

import { SITE, UI, FEATURES } from "@/config";
import { withBasePath } from "@/utils/path";

import type { BgType } from "@/types";

interface Props {
  title?: string;
  description?: string;
  ogImage?: string | boolean;
  bgType?: BgType | false;
  pubDate?: string;
  lastModDate?: string;
  pathname?: string;
  showNavBar?: boolean;
  showFooter?: boolean;
  showBackLink?: boolean;
}

const {
  title,
  description,
  ogImage,
  bgType,
  pubDate,
  lastModDate,
  pathname,
  showNavBar = true,
  showFooter = true,
  showBackLink = true,
} = Astro.props;

// Use provided pathname for prerendered pages, fall back to Astro.url.pathname for server-rendered
const currentPathname = pathname || Astro.url.pathname;

const { cspNonce } = Astro.locals;

let style: Record<string, string> = {};

const { slideEnterAnim } = FEATURES;
const enableSlideEnterAnim = Array.isArray(slideEnterAnim) && slideEnterAnim[0];
if (enableSlideEnterAnim)
  style["--enter-step"] = `${slideEnterAnim[1].enterStep}ms`;

const {
  externalLink: { newTab, cursorType },
} = UI;
const hasCustomCursor =
  newTab && cursorType.length > 0 && cursorType !== "pointer";
if (hasCustomCursor) style["--external-link-cursor"] = cursorType;
---

<!doctype html>
<html lang={SITE.lang} class="dark scroll-smooth">
  <head>
    <Head {title} {description} {ogImage} {pubDate} {lastModDate} />
    <style is:global>
      /* Mizu theme dark colors - default for all pages */
      :root {
        --c-bg: #0f172a;
        --c-text: #f8fafc;
        --c-scrollbar: #181818;
        --c-scrollbar-hover: #1f1f1f;
      }

      html {
        background-color: #0f172a;
        color: #f8fafc;
      }

      body {
        background-color: #0f172a;
        color: #f8fafc;
      }

      /* Ensure dark mode is applied */
      html.dark {
        --c-bg: #0f172a;
        --c-text: #f8fafc;
      }
    </style>
  </head>

  <body
    class="bg-slate-950 text-slate-50 font-sans min-h-screen flex flex-col overflow-x-hidden selection:bg-indigo-500/30"
    style={Object.keys(style).length !== 0 ? style : undefined}
    data-no-sliding={enableSlideEnterAnim ? undefined : ""}
  >
    <!-- Background -->
    {bgType && <Background type={bgType} />}

    <!-- Skip Link -->
    <Link
      href="#main"
      class="sr-only focus:(not-sr-only fixed start-1 top-1.5 op-20)"
    >
      Skip to content
    </Link>

    <!-- Nav Bar -->
    {showNavBar && <Navbar />}

    <!-- Main -->
    <main id="main" class="flex-grow w-full px-7 py-10 pt-24">
      <!-- Content -->
      <slot />
      <!-- Share -->
      {
        currentPathname !== withBasePath("/") && showBackLink && (
          <footer class="slide-enter animate-delay-1000! prose mx-auto mt-8 print:hidden">
            <slot name="share" />
            <br />
            <BackLink />
          </footer>
        )
      }
      <!-- Comments -->
      <slot name="giscus" />
    </main>

    <!-- Footer -->
    {
      showFooter && (
        <>
          <Footer />
          <ToTopButton />
        </>
      )
    }

    <!-- Panel Backdrop (on mobile) -->
    <Backdrop />

    <!-- Progress Bar -->
    <script nonce={cspNonce}>
      import nprogress from "nprogress";

      document.addEventListener("astro:before-preparation", () => {
        nprogress.start();
      });

      document.addEventListener("astro:page-load", () => {
        nprogress.done();
      });
    </script>

    <!-- Vercel Speed Insights -->
    <SpeedInsights />
  </body>
</html>
