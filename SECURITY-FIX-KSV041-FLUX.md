# KSV041 Security Fix Summary - Flux ClusterRole

**Date**: October 7, 2025
**Severity**: CRITICAL
**Vulnerability ID**: KSV041
**Status**: âœ… RESOLVED

## Quick Summary

Fixed critical security vulnerability where Flux's `crd-controller-flux-system` ClusterRole had cluster-wide read access to all secrets across all namespaces, which is equivalent to cluster-admin access.

## Changes Made

### Files Created
1. `clusters/pixelkube/flux-system/flux-clusterrole-secrets-patch.yaml` - Patch to remove cluster-wide secret access
2. `clusters/pixelkube/flux-system/flux-namespace-secret-role.yaml` - Namespace-scoped secret access for flux-system
3. `docs/security/KSV041-flux-clusterrole-fix.md` - Detailed documentation

### Files Modified
1. `clusters/pixelkube/flux-system/kustomization.yaml` - Added patch configuration and namespace-scoped Role

## Security Impact

**Before**: Flux could read ALL secrets in ALL namespaces (equivalent to cluster-admin)
**After**: Flux can only read secrets in the `flux-system` namespace

## Verification Commands

```bash
# Verify secrets removed from ClusterRole
kubectl kustomize clusters/pixelkube/flux-system/ | grep -A 50 "name: crd-controller-flux-system" | grep secrets
# Should return no results (exit code 1)

# Verify namespace-scoped Role exists
kubectl kustomize clusters/pixelkube/flux-system/ | grep -A 15 "name: flux-secret-reader"
# Should show Role and RoleBinding in flux-system namespace
```

## Deployment

To apply this fix to your cluster:

```bash
# Test the kustomization first
kubectl kustomize clusters/pixelkube/flux-system/

# Apply when ready
kubectl apply -k clusters/pixelkube/flux-system/

# Or let Flux reconcile automatically if using GitOps
flux reconcile kustomization flux-system
```

## Related Security Fixes

This follows the same pattern as the previous KSV041 fix for Caddy Ingress Controller. See:
- `docs/security/KSV041-caddy-clusterrole-fix.md`
- `SECURITY-FIX-KSV045.md`

## Notes

- This fix uses Kustomize strategic merge patches to override the auto-generated Flux manifest
- The original `gotk-components.yaml` remains unchanged (as it's auto-generated by Flux)
- If Flux needs secret access in additional namespaces, create additional namespace-scoped Roles
- This adheres to the principle of least privilege and Kubernetes RBAC best practices
