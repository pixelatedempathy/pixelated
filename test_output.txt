
[1m[46m RUN [49m[22m [36mv4.0.18 [39m[90m/home/vivi/pixelated[39m

[90mstderr[2m | tests/integration/auth0/auth0-integration.test.ts[2m > [22m[2mAuth0 Integration Tests[2m > [22m[2mEmail/Password Authentication Flow[2m > [22m[2mshould reject authentication with invalid credentials
[22m[39mAuth0 sign in error: Error: Unauthorized
    at [90m/home/vivi/pixelated/[39mtests/integration/auth0/auth0-integration.test.ts:221:54
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/vitest@4.0.18_@opentelemetry+api@1.9.0_@types+node@25.0.10_jiti@2.6.1_jsdom@27.4.0_@nob_a9d14549d65772605a2cd1bf6e03bdde/node_modules/[4mvitest[24m/dist/chunks/traces.CCmnQaNT.js:142:27[90m)[39m
    at trace [90m(file:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/vitest@4.0.18_@opentelemetry+api@1.9.0_@types+node@25.0.10_jiti@2.6.1_jsdom@27.4.0_@nob_a9d14549d65772605a2cd1bf6e03bdde/node_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/integration/auth0/auth0-integration.test.ts[2m > [22m[2mAuth0 Integration Tests[2m > [22m[2mSocial Authentication Flow[2m > [22m[2mshould complete full authentication flow
[22m[39mSocial authentication successful {
  userId: [32m'google-oauth2|123456789'[39m,
  email: [32m'user@example.com'[39m,
  provider: [32m'google-oauth2'[39m
}

[90mstderr[2m | tests/integration/auth0/auth0-integration.test.ts[2m > [22m[2mAuth0 Integration Tests[2m > [22m[2mRole-Based Access Control[2m > [22m[2mshould check if user has specific role
[22m[39mFailed to get roles for user auth0|user123: TypeError: Cannot read properties of undefined (reading 'map')
    at getUserRoles [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:502:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.userHasRole [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:513:17[90m)[39m
    at [90m/home/vivi/pixelated/[39mtests/integration/auth0/auth0-integration.test.ts:537:23
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/auth0/auth0-integration.test.ts[2m > [22m[2mAuth0 Integration Tests[2m > [22m[2mRole-Based Access Control[2m > [22m[2mshould check if user has specific permission
[22m[39mFailed to get roles for user auth0|user123: TypeError: Cannot read properties of undefined (reading 'map')
    at getUserRoles [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:502:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.userHasPermission [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:527:23[90m)[39m
    at [90m/home/vivi/pixelated/[39mtests/integration/auth0/auth0-integration.test.ts:546:29
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/auth0/auth0-integration.test.ts[2m > [22m[2mAuth0 Integration Tests[2m > [22m[2mRole-Based Access Control[2m > [22m[2mshould get all permissions for user
[22m[39mFailed to get roles for user auth0|user123: TypeError: Cannot read properties of undefined (reading 'map')
    at getUserRoles [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:502:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.getUserPermissions [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:559:23[90m)[39m
    at [90m/home/vivi/pixelated/[39mtests/integration/auth0/auth0-integration.test.ts:555:27
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/auth0/auth0-integration.test.ts[2m > [22m[2mAuth0 Integration Tests[2m > [22m[2mCross-Flow Integration[2m > [22m[2mshould properly handle role-based access after authentication
[22m[39mFailed to get roles for user auth0|123456: TypeError: Cannot read properties of undefined (reading 'map')
    at getUserRoles [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:502:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.userHasPermission [90m(/home/vivi/pixelated/[39msrc/lib/auth/auth0-rbac-service.ts:527:23[90m)[39m
    at [90m/home/vivi/pixelated/[39mtests/integration/auth0/auth0-integration.test.ts:778:29
    at [90mfile:///home/vivi/pixelated/[39mnode_modules/[4m.pnpm[24m/@vitest+runner@4.0.18/node_modules/[4m@vitest/runner[24m/dist/index.js:915:20

 [31mâ¯[39m tests/integration/auth0/auth0-integration.test.ts [2m([22m[2m23 tests[22m[2m | [22m[31m18 failed[39m[2m)[22m[33m 366[2mms[22m[39m
[31m       [31mÃ—[31m should successfully authenticate user with valid credentials[39m[32m 15[2mms[22m[39m
       [32mâœ“[39m should reject authentication with invalid credentials[32m 6[2mms[22m[39m
[31m       [31mÃ—[31m should create new user account[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should generate correct Google authorization URL[39m[32m 3[2mms[22m[39m
       [32mâœ“[39m should successfully exchange authorization code for tokens[32m 1[2mms[22m[39m
       [32mâœ“[39m should successfully get user information from access token[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should complete full authentication flow[39m[32m 3[2mms[22m[39m
[31m       [31mÃ—[31m should validate a valid access token[39m[32m 5[2mms[22m[39m
[31m       [31mÃ—[31m should reject an expired token[39m[32m 2[2mms[22m[39m
       [32mâœ“[39m should successfully refresh access token[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should revoke token successfully[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should assign role to user[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should check if user has specific role[39m[32m 5[2mms[22m[39m
[31m       [31mÃ—[31m should check if user has specific permission[39m[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should get all permissions for user[39m[32m 3[2mms[22m[39m
       [32mâœ“[39m should validate role transition[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should log security events for login attempts[39m[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should log security events for role assignments[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should log security events for token validation[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should log security events for token refresh[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should maintain consistent user data across authentication flows[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should properly link social account to existing user[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should properly handle role-based access after authentication[39m[32m 1[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 18 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mEmail/Password Authentication Flow[2m > [22mshould successfully authenticate user with valid credentials
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ { â€¦(5) } ][90m

Received: 

[1m  1st vi.fn() call:

[22m[33m@@ -1,8 +1,8 @@[90m
[2m  [[22m
[2m    {[22m
[32m-     "audience": "test-audience",[90m
[31m+     "audience": "https://api.pixelated-empathy.com",[90m
[2m      "password": "password123",[22m
[2m      "realm": "Username-Password-Authentication",[22m
[2m      "scope": "openid profile email",[22m
[2m      "username": "test@example.com",[22m
[2m    },[22m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m199:44[22m[39m
    [90m197| [39m      })
    [90m198| [39m
    [90m199| [39m      [34mexpect[39m(mockAuthClient[33m.[39mpasswordGrant)[33m.[39m[34mtoHaveBeenCalledWith[39m({
    [90m   | [39m                                           [31m^[39m
    [90m200| [39m        username[33m:[39m [32m'test@example.com'[39m[33m,[39m
    [90m201| [39m        password[33m:[39m [32m'password123'[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mEmail/Password Authentication Flow[2m > [22mshould create new user account
[31m[1mReferenceError[22m: Cannot access 'mockManagementClient2' before initialization[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m239:36[22m[39m
    [90m237| [39m      }
    [90m238| [39m
    [90m239| [39m      [35mconst[39m mockManagementClient [33m=[39m mockManagementClient
    [90m   | [39m                                   [31m^[39m
    [90m240| [39m      mockManagementClient[33m.[39mcreateUser[33m.[39m[34mmockResolvedValue[39m(mockAuth0User)
    [90m241| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mSocial Authentication Flow[2m > [22mshould generate correct Google authorization URL
[31m[1mAssertionError[22m: expected 'https://test-domain.auth0.com/authoriâ€¦' to be 'https://test-domain.auth0.com/authoriâ€¦' // Object.is equality[39m

Expected: [32m"https://test-domain.auth0.com/authorize?response_type=code&client_id=test-client-id&connection=google-oauth2&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback&scope=openid[7m%20[27mprofile[7m%20[27memail&state=test-state"[39m
Received: [31m"https://test-domain.auth0.com/authorize?response_type=code&client_id=test-client-id&connection=google-oauth2&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback&scope=openid[7m+[27mprofile[7m+[27memail&state=test-state"[39m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m277:19[22m[39m
    [90m275| [39m      const url = auth0SocialAuthService.getGoogleAuthorizationUrl('htâ€¦
    [90m276| [39m
    [90m277| [39m      [34mexpect[39m(url)[33m.[39m[34mtoBe[39m(
    [90m   | [39m                  [31m^[39m
    [90m278| [39m        [32m'https://test-domain.auth0.com/authorize?'[39m [33m+[39m
    [90m279| [39m        [32m'response_type=code&'[39m [33m+[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mSocial Authentication Flow[2m > [22mshould complete full authentication flow
[31m[1mError[22m: Cannot find module '../../src/lib/security/index'
Require stack:
- /home/vivi/pixelated/tests/integration/auth0/auth0-integration.test.ts[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m390:30[22m[39m
    [90m388| [39m
    [90m389| [39m      [90m// Verify security event was logged[39m
    [90m390| [39m      [35mconst[39m securityModule [33m=[39m [34mrequire[39m([32m'../../src/lib/security/index'[39m)
    [90m   | [39m                             [31m^[39m
    [90m391| [39m      [34mexpect[39m(securityModule[33m.[39mlogSecurityEvent)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m392| [39m        securityModule[33m.[39m[33mSecurityEventType[39m[33m.[39m[33mLOGIN[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mJWT Token Validation and Refresh[2m > [22mshould validate a valid access token
[31m[1mAssertionError[22m: expected { valid: false, â€¦(1) } to deeply equal { valid: true, â€¦(5) }[39m

[32m- Expected[39m
[31m+ Received[39m

[2m  {[22m
[32m-   "expiresAt": 1769307580,[39m
[32m-   "payload": {[39m
[32m-     "exp": 1769307580,[39m
[32m-     "https://pixelated.empathy/app_metadata": {[39m
[32m-       "roles": [[39m
[32m-         "admin",[39m
[32m-       ],[39m
[32m-     },[39m
[32m-     "https://pixelated.empathy/user_metadata": {[39m
[32m-       "role": "admin",[39m
[32m-     },[39m
[32m-     "jti": "token-id-123",[39m
[32m-     "sub": "auth0|123456",[39m
[32m-   },[39m
[32m-   "role": "admin",[39m
[32m-   "tokenId": "token-id-123",[39m
[32m-   "userId": "auth0|123456",[39m
[32m-   "valid": true,[39m
[31m+   "error": "Malformed token",[39m
[31m+   "valid": false,[39m
[2m  }[22m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m418:22[22m[39m
    [90m416| [39m      const result = await auth0JwtService.validateToken('valid-token'â€¦
    [90m417| [39m
    [90m418| [39m      [34mexpect[39m(result)[33m.[39m[34mtoEqual[39m({
    [90m   | [39m                     [31m^[39m
    [90m419| [39m        valid[33m:[39m [35mtrue[39m[33m,[39m
    [90m420| [39m        userId[33m:[39m [32m'auth0|123456'[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mJWT Token Validation and Refresh[2m > [22mshould reject an expired token
[31m[1mAssertionError[22m: expected { valid: false, â€¦(1) } to deeply equal { valid: false, â€¦(1) }[39m

[32m- Expected[39m
[31m+ Received[39m

[2m  {[22m
[32m-   "error": "Token has expired",[39m
[31m+   "error": "Malformed token",[39m
[2m    "valid": false,[22m
[2m  }[22m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m442:22[22m[39m
    [90m440| [39m      const result = await auth0JwtService.validateToken('expired-tokeâ€¦
    [90m441| [39m
    [90m442| [39m      [34mexpect[39m(result)[33m.[39m[34mtoEqual[39m({
    [90m   | [39m                     [31m^[39m
    [90m443| [39m        valid[33m:[39m [35mfalse[39m[33m,[39m
    [90m444| [39m        error[33m:[39m [32m'Token has expired'[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mJWT Token Validation and Refresh[2m > [22mshould revoke token successfully
[31m[1mError[22m: Cannot find module '../../../src/lib/redis'
Require stack:
- /home/vivi/pixelated/tests/integration/auth0/auth0-integration.test.ts[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m488:27[22m[39m
    [90m486| [39m
    [90m487| [39m    [34mit[39m([32m'should revoke token successfully'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m488| [39m      [35mconst[39m redisModule [33m=[39m [34mrequire[39m([32m'../../../src/lib/redis'[39m)
    [90m   | [39m                          [31m^[39m
    [90m489| [39m      redisModule[33m.[39msetInCache[33m.[39m[34mmockResolvedValue[39m(undefined)
    [90m490| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mRole-Based Access Control[2m > [22mshould assign role to user
[31m[1mReferenceError[22m: Cannot access 'mockManagementClient2' before initialization[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m503:36[22m[39m
    [90m501| [39m  [34mdescribe[39m([32m'Role-Based Access Control'[39m[33m,[39m () [33m=>[39m {
    [90m502| [39m    [34mit[39m([32m'should assign role to user'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m503| [39m      [35mconst[39m mockManagementClient [33m=[39m mockManagementClient
    [90m   | [39m                                   [31m^[39m
    [90m504| [39m
    [90m505| [39m      [90m// Mock role lookup[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mRole-Based Access Control[2m > [22mshould check if user has specific role
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m539:23[22m[39m
    [90m537| [39m      const hasRole = await auth0RbacService.userHasRole('auth0|user12â€¦
    [90m538| [39m
    [90m539| [39m      [34mexpect[39m(hasRole)[33m.[39m[34mtoBe[39m([35mtrue[39m)
    [90m   | [39m                      [31m^[39m
    [90m540| [39m    })
    [90m541| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mRole-Based Access Control[2m > [22mshould check if user has specific permission
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m548:29[22m[39m
    [90m546| [39m      const hasPermission = await auth0RbacService.userHasPermission('â€¦
    [90m547| [39m
    [90m548| [39m      expect(hasPermission).toBe(true) // therapists have read:patientâ€¦
    [90m   | [39m                            [31m^[39m
    [90m549| [39m    })
    [90m550| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mRole-Based Access Control[2m > [22mshould get all permissions for user
[31m[1mAssertionError[22m: expected [] to include 'read:patients'[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m558:27[22m[39m
    [90m556| [39m
    [90m557| [39m      [90m// Admin should have all permissions[39m
    [90m558| [39m      [34mexpect[39m(permissions)[33m.[39m[34mtoContain[39m([32m'read:patients'[39m)
    [90m   | [39m                          [31m^[39m
    [90m559| [39m      [34mexpect[39m(permissions)[33m.[39m[34mtoContain[39m([32m'manage:roles'[39m)
    [90m560| [39m      expect(permissions.length).toBeGreaterThan(20) // Should have maâ€¦

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mSecurity Features and Logging[2m > [22mshould log security events for login attempts
[31m[1mError[22m: Cannot find module '../../src/lib/security/index'
Require stack:
- /home/vivi/pixelated/tests/integration/auth0/auth0-integration.test.ts[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m598:30[22m[39m
    [90m596| [39m
    [90m597| [39m      [90m// Verify security event was logged[39m
    [90m598| [39m      [35mconst[39m securityModule [33m=[39m [34mrequire[39m([32m'../../src/lib/security/index'[39m)
    [90m   | [39m                             [31m^[39m
    [90m599| [39m      [34mexpect[39m(securityModule[33m.[39mlogSecurityEvent)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m600| [39m        securityModule[33m.[39m[33mSecurityEventType[39m[33m.[39m[33mLOGIN[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mSecurity Features and Logging[2m > [22mshould log security events for role assignments
[31m[1mReferenceError[22m: Cannot access 'mockManagementClient2' before initialization[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m610:36[22m[39m
    [90m608| [39m
    [90m609| [39m    [34mit[39m([32m'should log security events for role assignments'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m610| [39m      [35mconst[39m mockManagementClient [33m=[39m mockManagementClient
    [90m   | [39m                                   [31m^[39m
    [90m611| [39m
    [90m612| [39m      [90m// Mock role lookup[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[13/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mSecurity Features and Logging[2m > [22mshould log security events for token validation
[31m[1mError[22m: Cannot find module '../../src/lib/security/index'
Require stack:
- /home/vivi/pixelated/tests/integration/auth0/auth0-integration.test.ts[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m648:30[22m[39m
    [90m646| [39m
    [90m647| [39m      [90m// Verify security event was logged[39m
    [90m648| [39m      [35mconst[39m securityModule [33m=[39m [34mrequire[39m([32m'../../src/lib/security/index'[39m)
    [90m   | [39m                             [31m^[39m
    [90m649| [39m      [34mexpect[39m(securityModule[33m.[39mlogSecurityEvent)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m650| [39m        securityModule[33m.[39m[33mSecurityEventType[39m[33m.[39m[33mTOKEN_VALIDATED[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[14/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mSecurity Features and Logging[2m > [22mshould log security events for token refresh
[31m[1mError[22m: Cannot find module '../../src/lib/security/index'
Require stack:
- /home/vivi/pixelated/tests/integration/auth0/auth0-integration.test.ts[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m682:30[22m[39m
    [90m680| [39m
    [90m681| [39m      [90m// Verify security event was logged[39m
    [90m682| [39m      [35mconst[39m securityModule [33m=[39m [34mrequire[39m([32m'../../src/lib/security/index'[39m)
    [90m   | [39m                             [31m^[39m
    [90m683| [39m      [34mexpect[39m(securityModule[33m.[39mlogSecurityEvent)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m684| [39m        securityModule[33m.[39m[33mSecurityEventType[39m[33m.[39m[33mTOKEN_REFRESHED[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[15/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mCross-Flow Integration[2m > [22mshould maintain consistent user data across authentication flows
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m721:43[22m[39m
    [90m719| [39m
    [90m720| [39m      [90m// Verify consistency[39m
    [90m721| [39m      [34mexpect[39m(tokenValidationResult[33m.[39mvalid)[33m.[39m[34mtoBe[39m([35mtrue[39m)
    [90m   | [39m                                          [31m^[39m
    [90m722| [39m      expect(tokenValidationResult.userId).toBe(emailAuthResult.user.iâ€¦
    [90m723| [39m      expect(tokenValidationResult.role).toBe(emailAuthResult.user.rolâ€¦

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[16/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mCross-Flow Integration[2m > [22mshould properly link social account to existing user
[31m[1mReferenceError[22m: Cannot access 'mockManagementClient2' before initialization[39m
[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m727:36[22m[39m
    [90m725| [39m
    [90m726| [39m    it('should properly link social account to existing user', async (â€¦
    [90m727| [39m      [35mconst[39m mockManagementClient [33m=[39m mockManagementClient
    [90m   | [39m                                   [31m^[39m
    [90m728| [39m      mockManagementClient[33m.[39mlinkUsers[33m.[39m[34mmockResolvedValue[39m({})
    [90m729| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[17/18]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth0/auth0-integration.test.ts[2m > [22mAuth0 Integration Tests[2m > [22mCross-Flow Integration[2m > [22mshould properly handle role-based access after authentication
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/auth0/auth0-integration.test.ts:[2m781:29[22m[39m
    [90m779| [39m
    [90m780| [39m      [90m// Therapists should have read:patients permission[39m
    [90m781| [39m      [34mexpect[39m(hasPermission)[33m.[39m[34mtoBe[39m([35mtrue[39m)
    [90m   | [39m                            [31m^[39m
    [90m782| [39m    })
    [90m783| [39m  })

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[18/18]â¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m18 failed[39m[22m[2m | [22m[1m[32m5 passed[39m[22m[90m (23)[39m
[2m   Start at [22m 20:19:39
[2m   Duration [22m 740ms[2m (transform 337ms, setup 0ms, import 166ms, tests 366ms, environment 0ms)[22m

